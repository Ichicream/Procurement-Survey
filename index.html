<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสำรวจความต้องการพัสดุ พ.ศ. 2569</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Security Protection -->
    <script>
        // Disable right click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            alert('การคลิกขวาถูกปิดใช้งาน เพื่อป้องกันการดู source code');
            return false;
        });
        
        // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S
        document.addEventListener('keydown', function(e) {
            // F12
            if (e.keyCode === 123) {
                e.preventDefault();
                alert('การใช้ Developer Tools ถูกปิดใช้งาน');
                return false;
            }
            // Ctrl+Shift+I (Developer Tools)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                alert('การใช้ Developer Tools ถูกปิดใช้งาน');
                return false;
            }
            // Ctrl+U (View Source)
            if (e.ctrlKey && e.keyCode === 85) {
                e.preventDefault();
                alert('การดู source code ถูกปิดใช้งาน');
                return false;
            }
            // Ctrl+S (Save Page)
            if (e.ctrlKey && e.keyCode === 83) {
                e.preventDefault();
                alert('การบันทึกหน้าเว็บถูกปิดใช้งาน');
                return false;
            }
            // Ctrl+A (Select All)
            if (e.ctrlKey && e.keyCode === 65) {
                e.preventDefault();
                alert('การเลือกทั้งหมดถูกปิดใช้งาน');
                return false;
            }
            // Ctrl+C (Copy)
            if (e.ctrlKey && e.keyCode === 67) {
                e.preventDefault();
                alert('การคัดลอกถูกปิดใช้งาน');
                return false;
            }
        });
        
        // Disable text selection
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Disable drag
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Console warning
        console.clear();
        console.log('%cหยุด!', 'color: red; font-size: 50px; font-weight: bold;');
        console.log('%cนี่คือฟีเจอร์ของเบราว์เซอร์ที่มีไว้สำหรับนักพัฒนา', 'color: red; font-size: 16px;');
        console.log('%cการใช้ที่นี่อาจทำให้ผู้ไม่หวังดีสามารถขโมยข้อมูลของคุณได้', 'color: red; font-size: 16px;');
        
        // DevTools detection
        let devtools = {open: false, orientation: null};
        const threshold = 160;
        setInterval(function() {
            if (window.outerHeight - window.innerHeight > threshold || 
                window.outerWidth - window.innerWidth > threshold) {
                if (!devtools.open) {
                    devtools.open = true;
                    alert('ตรวจพบการเปิด Developer Tools! กรุณาปิดเพื่อความปลอดภัย');
                    document.body.innerHTML = '<div style="text-align:center;margin-top:200px;"><h1>การเข้าถึงถูกปฏิเสธ</h1><p>กรุณาปิด Developer Tools และรีเฟรชหน้าเว็บ</p></div>';
                }
            } else {
                devtools.open = false;
            }
        }, 1000);
    </script>
    
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        /* Print button styles */
        .print-button {
            background: linear-gradient(135deg, #059669, #047857);
            transition: all 0.3s ease;
        }
        .print-button:hover {
            background: linear-gradient(135deg, #047857, #065f46);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        
        /* Responsive button layout */
        @media (max-width: 640px) {
            .button-container {
                flex-direction: column;
                gap: 12px;
            }
            .button-container button {
                width: 100%;
            }
        }

        /* Manual Tab Styles */
        .flowchart-node {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            min-width: 200px;
            margin: 8px;
        }

        .flowchart-node.start {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .flowchart-node.process {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .flowchart-node.decision {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            min-width: 250px;
        }

        .flowchart-node.end {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .flowchart-arrow {
            font-size: 24px;
            color: #6b7280;
            margin: 8px 0;
        }

        .flowchart-arrow-left {
            font-size: 24px;
            color: #ef4444;
            margin: 8px 0;
            transform: rotate(180deg);
        }

        /* Status button styles */
        .status-button {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .status-button:hover {
            opacity: 0.8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .status-button:active {
            transform: translateY(0);
        }

        .step-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.12);
            transform: translateY(-3px);
        }

        .step-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 24px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .step-number {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            margin-right: 20px;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.25);
        }

        .step-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .step-content {
            padding: 24px;
            line-height: 1.7;
        }

        .feature-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            transform: translateY(-3px);
        }

        .feature-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .feature-description {
            color: #6b7280;
            line-height: 1.6;
            font-size: 14px;
        }

        .troubleshoot-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .troubleshoot-question {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            padding: 16px 20px;
            margin: 0;
            font-weight: 600;
            color: #92400e;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .troubleshoot-question:hover {
            background: linear-gradient(135deg, #fde68a, #fcd34d);
        }

        .troubleshoot-answer {
            padding: 16px 20px;
            background: #fffbeb;
        }

        .troubleshoot-answer ul li {
            color: #78350f;
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-6 shadow-lg">
        <div class="container mx-auto px-6">
            <h1 class="text-3xl font-bold text-center">ระบบสำรวจความต้องการพัสดุ (จัดซื้อ/จัดจ้าง)</h1>
            <p class="text-center mt-2 text-blue-100">ประจำปีงบประมาณ พ.ศ. 2569</p>
            <p class="text-center text-sm text-blue-200 mt-1">คณะมนุษยศาสตร์และสังคมศาสตร์ มหาวิทยาลัยราชภัฏสุราษฎร์ธานี</p>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="container mx-auto px-6 mt-6">
        <div class="flex bg-white rounded-lg shadow-md p-2 mb-6">
            <button class="tab-button active flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 hover:bg-blue-50" onclick="switchTab('survey')">
                📝 แบบสำรวจ

            <button class="tab-button flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 hover:bg-blue-50" onclick="switchTab('tracking')">
                📊 รายงาน

            <button class="tab-button flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 hover:bg-blue-50" onclick="switchTab('manual')">
                📖 คู่มือการใช้งาน

        </div>

        <!-- Firebase Status Indicator -->
        <div class="mb-4">
            <div id="firebaseStatus" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 rounded-r-lg text-sm">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-500 mr-2"></div>
                    <span>🔄 กำลังเชื่อมต่อกับฐานข้อมูล Firebase...</span>
                </div>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="mb-4">
            <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 rounded-r-lg text-sm">
                <div class="flex items-center">
                    <div class="mr-2">🔒</div>
                    <div>
                        <div class="font-semibold">ข้อมูลความปลอดภัย</div>
                        <div class="text-xs mt-1">ระบบนี้ได้รับการป้องกันด้วยมาตรการความปลอดภัยขั้นสูง การพยายามเข้าถึง source code หรือข้อมูลระบบจะถูกบันทึกไว้</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Survey Tab -->
        <div id="survey" class="tab-content active">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <!-- ส่วนแสดงงบประมาณ -->
                <div class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 text-center border-b-2 border-blue-300 pb-2">
                        💰 งบประมาณประจำปี พ.ศ. 2569
                    </h2>
                    <div class="space-y-6">
                        <!-- โครงการ 1: งบแผ่นดิน -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-blue-100">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-semibold text-blue-800">โครงการพัฒนาคุณภาพการเรียนการสอน คณะมนุษยศาสตร์และสังคมศาสตร์</h3>
                                <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">(งบแผ่นดิน)</span>
                            </div>
                            
                            <!-- แถบแสดงสัดส่วน -->
                            <div class="mb-3">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">การใช้งบประมาณ</span>
                                    <span id="project1Percentage" class="font-semibold text-gray-800">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                    <div id="project1ProgressBar" class="bg-gradient-to-r from-green-400 to-green-500 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>ใช้แล้ว: <span id="project1Used" class="font-medium">0 บาท</span></span>
                                    <span>คงเหลือ: <span id="project1Remaining" class="font-medium">1,442,200 บาท</span></span>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">งบรวมทั้งหมด:</span>
                                    <span class="font-semibold text-green-600">1,442,200 บาท</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">คงเหลือ:</span>
                                    <span id="project1RemainingDisplay" class="font-semibold text-orange-600">1,442,200 บาท</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- โครงการ 2: งบเงินรายได้ -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-blue-100">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-semibold text-blue-800">โครงการพัฒนาคุณภาพการบริหารจัดการ คณะมนุษยศาสตร์และสังคมศาสตร์</h3>
                                <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">(งบเงินรายได้)</span>
                            </div>
                            
                            <!-- แถบแสดงสัดส่วน -->
                            <div class="mb-3">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">การใช้งบประมาณ</span>
                                    <span id="project2Percentage" class="font-semibold text-gray-800">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                    <div id="project2ProgressBar" class="bg-gradient-to-r from-green-400 to-green-500 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>ใช้แล้ว: <span id="project2Used" class="font-medium">0 บาท</span></span>
                                    <span>คงเหลือ: <span id="project2Remaining" class="font-medium">4,047,748 บาท</span></span>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">งบรวมทั้งหมด:</span>
                                    <span class="font-semibold text-green-600">4,047,748 บาท</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">คงเหลือ:</span>
                                    <span id="project2RemainingDisplay" class="font-semibold text-orange-600">4,047,748 บาท</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="surveyForm">
                    <!-- ส่วนที่ 1: ข้อมูลผู้ตอบแบบสำรวจ -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-blue-200 pb-2">
                            ส่วนที่ 1: ข้อมูลผู้ตอบแบบสำรวจ
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ชื่อ-สกุล ผู้ตอบแบบสำรวจ *</label>
                                <input type="text" id="fullName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">หน่วยงาน/ฝ่าย *</label>
                                <select id="department" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="">เลือกฝ่าย</option>
                                    <option value="งานบริหารงานทั่วไป">งานบริหารงานทั่วไป</option>
                                    <option value="งานบริการการศึกษา">งานบริการการศึกษา</option>
                                    <option value="งานเทคโนโลยีสารสนเทศ">งานเทคโนโลยีสารสนเทศ</option>
                                    <option value="สาขาวิชารัฐประศาสนศาสตร์">สาขาวิชารัฐประศาสนศาสตร์</option>
                                    <option value="สาขาวิชารัฐศาสตร์">สาขาวิชารัฐศาสตร์</option>
                                    <option value="สาขาวิชาจิตรกรรม">สาขาวิชาจิตรกรรม</option>
                                    <option value="สาขาวิชาดนตรีสากล">สาขาวิชาดนตรีสากล</option>
                                    <option value="สาขาวิชาการพัฒนาชุมชน">สาขาวิชาการพัฒนาชุมชน</option>
                                    <option value="สาขาวิชานวัตกรรมสังคมเพื่อการพัฒนาที่ยั่งยืน">สาขาวิชานวัตกรรมสังคมเพื่อการพัฒนาที่ยั่งยืน</option>
                                    <option value="สาขาวิชาการจัดการทางวัฒนธรรม">สาขาวิชาการจัดการทางวัฒนธรรม</option>
                                    <option value="สาขาวิชาภาษาจีน">สาขาวิชาภาษาจีน</option>
                                    <option value="สาขาวิชาภาษาอังกฤษ">สาขาวิชาภาษาอังกฤษ</option>
                                    <option value="สาขาวิชาภาษาอังกฤษเพื่ออาชีพ">สาขาวิชาภาษาอังกฤษเพื่ออาชีพ</option>
                                    <option value="สาขาวิชาภาษาไทย">สาขาวิชาภาษาไทย</option>
                                    <option value="สาขาวิชาสารสนเทศศาสตร์และบรรณารักษศาสตร์">สาขาวิชาสารสนเทศศาสตร์และบรรณารักษศาสตร์</option>
                                    <option value="กลุ่มวิชาปรัชญาและศาสนา">กลุ่มวิชาปรัชญาและศาสนา</option>
                                    <option value="กลุ่มวิชานาฏศิลป์">กลุ่มวิชานาฏศิลป์</option>
                                    <option value="กลุ่มวิชาภาษามลายู">กลุ่มวิชาภาษามลายู</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">วันที่กรอกข้อมูล</label>
                                <input type="date" id="submitDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- ส่วนที่ 2: รายการที่ต้องการจัดซื้อ/จัดจ้าง -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 border-b-2 border-blue-200 pb-2">
                                ส่วนที่ 2: รายการที่ต้องการจัดซื้อ/จัดจ้าง
                            </h2>
                            <button type="button" onclick="addItem()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                ➕ เพิ่มรายการ

                        </div>

                        <!-- เลือกโครงการและแนบเอกสาร -->
                        <div class="mb-6">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">เลือกโครงการ *</label>
                                    <select id="projectSelection" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        <option value="">เลือกโครงการ</option>
                                        <option value="โครงการพัฒนาคุณภาพการเรียนการสอน คณะมนุษยศาสตร์และสังคมศาสตร์ (งบแผ่นดิน)">โครงการพัฒนาคุณภาพการเรียนการสอน คณะมนุษยศาสตร์และสังคมศาสตร์ (งบแผ่นดิน)</option>
                                        <option value="โครงการพัฒนาคุณภาพการบริหารจัดการ คณะมนุษยศาสตร์และสังคมศาสตร์ (งบเงินรายได้)">โครงการพัฒนาคุณภาพการบริหารจัดการ คณะมนุษยศาสตร์และสังคมศาสตร์ (งบเงินรายได้)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">แนบเอกสารใบเสนอราคา</label>
                                    <input type="file" id="quotationFile" 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.webp"
                                           multiple>
                                    <p class="text-xs text-gray-500 mt-1">รองรับไฟล์: PDF, JPG, PNG, GIF (หลายไฟล์ได้)</p>
                                    <div id="fileList" class="mt-2 space-y-1"></div>
                                </div>
                            </div>
                        </div>

                        <!-- เลือกประเภทการจัดหาและพัสดุที่จัดหา -->
                        <div class="mb-6">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ประเภทการจัดหา *</label>
                                    <select id="procurementType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="updateProcurementItems()" required>
                                        <option value="">เลือกประเภทการจัดหา</option>
                                        <option value="ซื้อ">ซื้อ</option>
                                        <option value="จ้าง">จ้าง</option>
                                        <option value="เช่า">เช่า</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">พัสดุที่จัดหา *</label>
                                    <select id="procurementItem" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled required>
                                        <option value="">กรุณาเลือกประเภทการจัดหาก่อน</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">เลือกประเภทการจัดหาก่อน เพื่อแสดงพัสดุที่เกี่ยวข้อง</p>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">ลำดับ</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">รายการ</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">รายละเอียดวัสดุ/งานจ้าง</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">วัตถุประสงค์</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">จำนวน</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">หน่วยนับ</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">งบประมาณ/รายการ</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">งบประมาณรวม</th>
                                        <th class="border border-gray-300 px-3 py-3 text-center font-medium">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTable">
                                    <!-- Items will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr class="bg-blue-50 font-bold">
                                        <td colspan="6" class="border border-gray-300 px-3 py-3 text-right">รวมทั้งสิ้น:</td>
                                        <td class="border border-gray-300 px-3 py-3 text-center" id="totalBudget">0 บาท</td>
                                        <td colspan="2" class="border border-gray-300"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- ส่วนที่ 3: ระยะเวลาที่ต้องการใช้งานและความเร่งด่วน -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-blue-200 pb-2">
                            ส่วนที่ 3: ระยะเวลาที่ต้องการใช้งานและความเร่งด่วน
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ช่วงเวลาที่ต้องการใช้งานพัสดุ</label>
                                <select id="usagePeriod" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">เลือกเดือน</option>
                                    <option value="ตุลาคม 2568">ตุลาคม 2568</option>
                                    <option value="พฤศจิกายน 2568">พฤศจิกายน 2568</option>
                                    <option value="ธันวาคม 2568">ธันวาคม 2568</option>
                                    <option value="มกราคม 2569">มกราคม 2569</option>
                                    <option value="กุมภาพันธ์ 2569">กุมภาพันธ์ 2569</option>
                                    <option value="มีนาคม 2569">มีนาคม 2569</option>
                                    <option value="เมษายน 2569">เมษายน 2569</option>
                                    <option value="พฤษภาคม 2569">พฤษภาคม 2569</option>
                                    <option value="มิถุนายน 2569">มิถุนายน 2569</option>
                                    <option value="กรกฎาคม 2569">กรกฎาคม 2569</option>
                                    <option value="สิงหาคม 2569">สิงหาคม 2569</option>
                                    <option value="กันยายน 2569">กันยายน 2569</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ระดับความเร่งด่วน</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="urgency" value="ด่วนที่สุด (ภายใน 1 วัน)" class="mr-2">
                                        <span>🔴 ด่วนที่สุด (ภายใน 1 วัน)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="urgency" value="ด่วนมาก (ภายใน 1-3 วัน)" class="mr-2">
                                        <span>🟠 ด่วนมาก (ภายใน 1-3 วัน)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="urgency" value="ด่วน (ภายใน 1 สัปดาห์)" class="mr-2">
                                        <span>🟡 ด่วน (ภายใน 1 สัปดาห์)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="urgency" value="ปกติ (ภายใน 2 สัปดาห์)" class="mr-2">
                                        <span>🟢 ปกติ (ภายใน 2 สัปดาห์)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit and Print Buttons -->
                    <div class="text-center">
                        <div class="button-container flex justify-center space-x-4">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium text-lg transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1">
                                💾 บันทึกข้อมูล

                            <button type="button" onclick="printCurrentSurvey()" class="print-button text-white px-8 py-3 rounded-lg font-medium text-lg shadow-lg">
                                🖨️ พิมพ์แบบสำรวจ

                            <button type="button" onclick="printJobDetails()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-medium text-lg transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1">
                                📋 พิมพ์รายละเอียดงาน

                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Tab -->
        <div id="report" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">รายงานข้อมูลการสำรวจ</h2>
                    <div class="flex space-x-3">
                        <button onclick="updateReport()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            🔄 รีเฟรชข้อมูล

                        <button onclick="printReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            �️ พิมพ์รายงาน

                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 text-center">📊 สัดส่วนงบประมาณตามหน่วยงาน</h3>
                        <div class="flex justify-center">
                            <canvas id="budgetChart" width="300" height="300"></canvas>
                        </div>
                        <div id="budgetLegend" class="mt-4 text-sm"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 text-center">📦 สัดส่วนวัตถุประสงค์</h3>
                        <div class="flex justify-center">
                            <canvas id="purposeChart" width="300" height="300"></canvas>
                        </div>
                        <div id="purposeLegend" class="mt-4 text-sm"></div>
                    </div>
                </div>

                <!-- Search Filters -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">🔍 ตัวกรองการค้นหา</h3>
                    <div class="grid md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">เลขที่รายงาน</label>
                            <input type="text" id="filterReportNumber" placeholder="ค้นหาเลขที่รายงาน..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   onkeyup="filterReports()">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">รายการ</label>
                            <input type="text" id="filterItems" placeholder="ค้นหารายการ..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   onkeyup="filterReports()">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ผู้ส่งแบบสำรวจ</label>
                            <input type="text" id="filterSubmitter" placeholder="ค้นหาชื่อผู้ส่ง..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   onkeyup="filterReports()">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">หน่วยงาน</label>
                            <select id="filterDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    onchange="filterReports()">
                                <option value="">ทุกหน่วยงาน</option>
                                <option value="งานบริหารงานทั่วไป">งานบริหารงานทั่วไป</option>
                                <option value="งานบริการการศึกษา">งานบริการการศึกษา</option>
                                <option value="งานเทคโนโลยีสารสนเทศ">งานเทคโนโลยีสารสนเทศ</option>
                                <option value="สาขาวิชารัฐประศาสนศาสตร์">สาขาวิชารัฐประศาสนศาสตร์</option>
                                <option value="สาขาวิชารัฐศาสตร์">สาขาวิชารัฐศาสตร์</option>
                                <option value="สาขาวิชาจิตรกรรม">สาขาวิชาจิตรกรรม</option>
                                <option value="สาขาวิชาดนตรีสากล">สาขาวิชาดนตรีสากล</option>
                                <option value="สาขาวิชาการพัฒนาชุมชน">สาขาวิชาการพัฒนาชุมชน</option>
                                <option value="สาขาวิชานวัตกรรมสังคมเพื่อการพัฒนาที่ยั่งยืน">สาขาวิชานวัตกรรมสังคมเพื่อการพัฒนาที่ยั่งยืน</option>
                                <option value="สาขาวิชาการจัดการทางวัฒนธรรม">สาขาวิชาการจัดการทางวัฒนธรรม</option>
                                <option value="สาขาวิชาภาษาจีน">สาขาวิชาภาษาจีน</option>
                                <option value="สาขาวิชาภาษาอังกฤษ">สาขาวิชาภาษาอังกฤษ</option>
                                <option value="สาขาวิชาภาษาอังกฤษเพื่ออาชีพ">สาขาวิชาภาษาอังกฤษเพื่ออาชีพ</option>
                                <option value="สาขาวิชาภาษาไทย">สาขาวิชาภาษาไทย</option>
                                <option value="สาขาวิชาสารสนเทศศาสตร์และบรรณารักษศาสตร์">สาขาวิชาสารสนเทศศาสตร์และบรรณารักษศาสตร์</option>
                                <option value="กลุ่มวิชาปรัชญาและศาสนา">กลุ่มวิชาปรัชญาและศาสนา</option>
                                <option value="กลุ่มวิชานาฏศิลป์">กลุ่มวิชานาฏศิลป์</option>
                                <option value="กลุ่มวิชาภาษามลายู">กลุ่มวิชาภาษามลายู</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            🗑️ ล้างตัวกรอง

                        <div id="filterResults" class="text-sm text-gray-600">
                            <!-- Results count will be shown here -->
                        </div>
                    </div>
                </div>

                <div id="reportContent">
                    <p class="text-gray-500 text-center py-8">ยังไม่มีข้อมูลการสำรวจ กรุณากรอกแบบสำรวจก่อน</p>
                </div>
            </div>
        </div>

        <!-- Procurement Tracking Tab -->
        <div id="tracking" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">📊 รายงานการดำเนินการจัดซื้อจัดจ้าง</h2>
                </div>

                <!-- Charts Section - 2 Columns -->
                <div class="mb-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        <!-- Left Column: Department Chart -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">🏢 สัดส่วนตามฝ่าย/หน่วยงาน</h3>
                            <div class="flex items-start gap-6">
                                <!-- Chart Canvas -->
                                <div class="flex-shrink-0">
                                    <div style="position: relative; height: 200px; width: 200px;">
                                        <canvas id="departmentStatusChart"></canvas>
                                    </div>
                                </div>
                                <!-- Chart Legend -->
                                <div class="flex-1">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">รายละเอียดตามฝ่าย</h4>
                                    <div id="departmentStatusLegend" class="space-y-2 max-h-48 overflow-y-auto">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                    <div class="mt-3 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                                        <div class="text-xs text-gray-600">
                                            <div class="flex justify-between mb-1">
                                                <span class="font-medium">จำนวนฝ่าย/หน่วยงาน:</span>
                                                <span id="totalDepartments" class="font-bold text-blue-600">0 ฝ่าย</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium">งบประมาณรวมทุกฝ่าย:</span>
                                                <span id="totalDepartmentBudget" class="font-bold text-blue-600">0 บาท</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Status Chart -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">📊 สัดส่วนสถานะการดำเนินการ</h3>
                            <div class="flex items-start gap-6">
                                <!-- Chart Canvas -->
                                <div class="flex-shrink-0">
                                    <div style="position: relative; height: 200px; width: 200px;">
                                        <canvas id="trackingStatusChart"></canvas>
                                    </div>
                                </div>
                                <!-- Chart Legend -->
                                <div class="flex-1">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">รายละเอียดสถานะ</h4>
                                    <div id="trackingStatusLegend" class="space-y-2">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                    <div class="mt-3 p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-100">
                                        <div class="text-xs text-gray-600">
                                            <div class="flex justify-between mb-1">
                                                <span class="font-medium">รวมทั้งหมด:</span>
                                                <span id="totalTrackingItems" class="font-bold text-green-600">0 รายการ</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium">งบประมาณรวม:</span>
                                                <span id="totalTrackingBudget" class="font-bold text-green-600">0 บาท</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">🔍 ตัวกรองข้อมูล</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 mb-4">
                        <!-- Filter by Project -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">โครงการ</label>
                            <select id="filterTrackingProject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterTrackingData()">
                                <option value="">ทุกโครงการ</option>
                            </select>
                        </div>
                        
                        <!-- Filter by Department -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">หน่วยงาน</label>
                            <select id="filterTrackingDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterTrackingData()">
                                <option value="">ทุกหน่วยงาน</option>
                            </select>
                        </div>
                        
                        <!-- Filter by Procurement Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทการจัดหา</label>
                            <select id="filterTrackingType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onchange="filterTrackingData()">
                                <option value="">ทุกประเภท</option>
                                <option value="ซื้อ">ซื้อ</option>
                                <option value="จ้าง">จ้าง</option>
                                <option value="เช่า">เช่า</option>
                            </select>
                        </div>
                        
                        <!-- Search by Item/Description -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">รายการ/คำอธิบาย</label>
                            <input type="text" id="filterTrackingItems" placeholder="ค้นหาในรายการหรือคำอธิบาย..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" oninput="filterTrackingData()">
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 items-center">
                        <button onclick="clearTrackingFilters()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors text-sm">
                            🗑️ ล้างตัวกรอง
                        </button>
                        <button onclick="refreshTrackingData()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-sm">
                            🔄 รีเฟรชข้อมูล
                        </button>
                        <button onclick="printTrackingReport()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm">
                            🖨️ พิมพ์รายงาน
                        </button>
                        <div id="trackingFilterResults" class="text-sm text-gray-600 ml-auto">
                            <!-- Filter results will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Tracking Table -->
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">📋 รายการติดตามการดำเนินการ</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ลำดับ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ความเร่งด่วน</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-48">โครงการ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้ขอ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">พัสดุ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">งบประมาณ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่อัปเดต</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="trackingTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Tracking data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noTrackingData" class="text-center py-12 text-gray-500 hidden">
                        <div class="text-4xl mb-4">📋</div>
                        <p class="text-lg font-medium">ไม่มีข้อมูลการติดตาม</p>
                        <p class="text-sm">กรุณาบันทึกแบบสำรวจก่อนเพื่อเริ่มติดตามการดำเนินการ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Tab -->
        <div id="manual" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">📖 คู่มือการใช้งานระบบสำรวจความต้องการพัสดุ</h2>
                    <p class="text-gray-600 text-lg">ประจำปีงบประมาณ พ.ศ. 2569 | คณะมนุษยศาสตร์และสังคมศาสตร์</p>
                </div>

                <!-- Process Flowchart -->
                <div class="mb-12">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        ⚡ ขั้นตอนการใช้งานระบบ
                    </h3>
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
                        <!-- Modern Horizontal Flow -->
                        <div class="flex flex-wrap justify-center items-center gap-4 lg:gap-6">
                            <!-- Step 1: Input -->
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg hover:scale-105 transition-transform duration-200">
                                    �
                                </div>
                                <p class="text-sm font-medium text-gray-700 mt-2 text-center max-w-20">กรอกข้อมูล</p>
                            </div>
                            
                            <!-- Arrow -->
                            <div class="text-gray-400 text-xl hidden lg:block">→</div>
                            
                            <!-- Step 2: Select -->
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg hover:scale-105 transition-transform duration-200">
                                    �
                                </div>
                                <p class="text-sm font-medium text-gray-700 mt-2 text-center max-w-20">เพิ่มรายการ</p>
                            </div>
                            
                            <!-- Arrow -->
                            <div class="text-gray-400 text-xl hidden lg:block">→</div>
                            
                            <!-- Step 3: Review -->
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg hover:scale-105 transition-transform duration-200">
                                    ✅
                                </div>
                                <p class="text-sm font-medium text-gray-700 mt-2 text-center max-w-20">ตรวจสอบ</p>
                            </div>
                            
                            <!-- Arrow -->
                            <div class="text-gray-400 text-xl hidden lg:block">→</div>
                            
                            <!-- Step 4: Save -->
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg hover:scale-105 transition-transform duration-200">
                                    💾
                                </div>
                                <p class="text-sm font-medium text-gray-700 mt-2 text-center max-w-20">บันทึก</p>
                            </div>
                            
                            <!-- Arrow -->
                            <div class="text-gray-400 text-xl hidden lg:block">→</div>
                            
                            <!-- Step 5: Output -->
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg hover:scale-105 transition-transform duration-200">
                                    �
                                </div>
                                <p class="text-sm font-medium text-gray-700 mt-2 text-center max-w-20">ผลลัพธ์</p>
                            </div>
                        </div>                       
                        
                    </div>
                </div>

                <!-- Step by Step Guide -->
                <div class="mb-12">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        📋 ขั้นตอนการใช้งานแบบละเอียด
                    </h3>

                    <!-- Step 1 -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h4 class="step-title">การกรอกข้อมูลส่วนตัว</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">ข้อมูลที่ต้องกรอก:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• ชื่อ-นามสกุล ผู้ตอบแบบสำรวจ</li>
                                        <li>• หน่วยงาน/ฝ่ายที่สังกัด</li>
                                        <li>• วันที่กรอกข้อมูล (จะใส่อัตโนมัติ)</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">หมายเหตุ:</h5>
                                    <p class="text-sm text-gray-600">ช่องที่มีเครื่องหมาย * คือช่องที่จำเป็นต้องกรอก</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <h4 class="step-title">การเลือกโครงการงบประมาณ</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">โครงการที่เลือกได้:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li class="bg-blue-50 p-2 rounded">• โครงการพัฒนาคุณภาพการเรียนการสอน (งบแผ่นดิน)</li>
                                        <li class="bg-green-50 p-2 rounded">• โครงการพัฒนาคุณภาพการบริหารจัดการ (งบเงินรายได้)</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">ข้อสำคัญ:</h5>
                                    <p class="text-sm text-gray-600">งบประมาณจะถูกหักอัตโนมัติเมื่อบันทึกข้อมูล และจะแสดงยอดคงเหลือแบบ Real-time</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <h4 class="step-title">การเพิ่มรายการพัสดุ</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">ข้อมูลในแต่ละรายการ:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• รายการ (คุณลักษณะพัสดุ)</li>
                                        <li>• รายละเอียดวัสดุ/งานจ้าง</li>
                                        <li>• วัตถุประสงค์ (จัดซื้อใหม่/ทดแทน/เพิ่มเติม/ซ่อมบำรุง/ปรับปรุง)</li>
                                        <li>• จำนวนและหน่วยนับ</li>
                                        <li>• งบประมาณต่อหน่วย</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">การจัดการรายการ:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• กดปุ่ม "➕ เพิ่มรายการ" เพื่อเพิ่มแถวใหม่</li>
                                        <li>• กดปุ่ม "🗑️" เพื่อลบรายการ</li>
                                        <li>• งบประมาณรวมจะคำนวณอัตโนมัติ</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">4</div>
                            <h4 class="step-title">การแนบเอกสารและกำหนดความเร่งด่วน</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">การแนบไฟล์:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• รองรับไฟล์: PDF, JPG, PNG, GIF</li>
                                        <li>• สามารถแนบหลายไฟล์พร้อมกันได้</li>
                                        <li>• ดูรายการไฟล์ที่แนบด้านล่าง</li>
                                        <li>• สามารถลบไฟล์ด้วยปุ่ม ❌</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">ระดับความเร่งด่วน:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>🔴 ด่วนที่สุด (ภายใน 1 วัน)</li>
                                        <li>🟠 ด่วนมาก (ภายใน 1-3 วัน)</li>
                                        <li>🟡 ด่วน (ภายใน 1 สัปดาห์)</li>
                                        <li>🟢 ปกติ (ภายใน 2 สัปดาห์)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5 -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">5</div>
                            <h4 class="step-title">การบันทึกและตรวจสอบข้อมูล</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">การบันทึกข้อมูล:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• กดปุ่ม "💾 บันทึกข้อมูล"</li>
                                        <li>• ระบบจะตรวจสอบข้อมูลที่จำเป็น</li>
                                        <li>• หักงบประมาณจากโครงการที่เลือก</li>
                                        <li>• ซิงค์ข้อมูลกับ Firebase อัตโนมัติ</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">การพิมพ์เอกสาร:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• กดปุ่ม "🖨️ พิมพ์แบบสำรวจ"</li>
                                        <li>• สามารถพิมพ์ก่อนบันทึกได้</li>
                                        <li>• เอกสารจะมีส่วนลงนามและอนุมัติ</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6 - ใหม่: การดูรายงานและติดตาม -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">6</div>
                            <h4 class="step-title">การดูรายงานและติดตามการดำเนินการ</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">แท็บ "📊 รายงาน":</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• ดูกราฟสรุปงบประมาณตามฝ่าย</li>
                                        <li>• ดูกราฟประเภทการใช้งาน</li>
                                        <li>• กรองข้อมูลตามเงื่อนไข</li>
                                        <li>• พิมพ์รายงานสรุป</li>
                                        <li>• แก้ไข/ลบข้อมูล (ต้องใส่รหัสผ่าน)</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">แท็บ "📊 รายงาน" (ติดตาม):</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• ติดตามสถานะการดำเนินการ</li>
                                        <li>• อัปเดตสถานะ (ต้องใส่รหัสผ่าน)</li>
                                        <li>• ดูกราฟสถานะและฝ่าย</li>
                                        <li>• กรองข้อมูลแบบละเอียด</li>
                                        <li>• พิมพ์รายงานการติดตาม</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 7 - ใหม่: การใช้ตัวกรองข้อมูล -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">7</div>
                            <h4 class="step-title">การใช้ตัวกรองข้อมูลในการติดตาม</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">ตัวกรองที่มีให้:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>🔸 <strong>โครงการ</strong> - เลือกจากรายการโครงการ</li>
                                        <li>🔸 <strong>หน่วยงาน</strong> - เลือกจากรายการฝ่าย</li>
                                        <li>🔸 <strong>ประเภทการจัดหา</strong> - ซื้อ/จ้าง/เช่า</li>
                                        <li>🔸 <strong>รายการ/คำอธิบาย</strong> - ค้นหาแบบ Text</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">ปุ่มควบคุม:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>🗑️ <strong>ล้างตัวกรอง</strong> - ลบการกรองทั้งหมด</li>
                                        <li>🔄 <strong>รีเฟรชข้อมูล</strong> - อัปเดตข้อมูลล่าสุด</li>
                                        <li>🖨️ <strong>พิมพ์รายงาน</strong> - พิมพ์ข้อมูลที่กรองแล้ว</li>
                                        <li>📊 แสดงจำนวนรายการที่กรองได้</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 8 - ใหม่: การพิมพ์รายงาน -->
                    <div class="step-card mb-6">
                        <div class="step-header">
                            <div class="step-number">8</div>
                            <h4 class="step-title">การพิมพ์รายงานแบบต่างๆ</h4>
                        </div>
                        <div class="step-content">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">รายงานที่พิมพ์ได้:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>📄 <strong>แบบสำรวจ</strong> - เอกสารแบบสำรวจปกติ</li>
                                        <li>📋 <strong>รายละเอียดงาน</strong> - เอกสารสำหรับส่งงาน</li>
                                        <li>📊 <strong>รายงานสรุป</strong> - รายงานข้อมูลทั้งหมด</li>
                                        <li>📈 <strong>รายงานการติดตาม</strong> - รายงานสถานะ + กราฟ</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-gray-800 mb-2">เนื้อหาในรายงานติดตาม:</h5>
                                    <ul class="space-y-1 text-sm text-gray-700">
                                        <li>• ส่วนหัวพร้อมเงื่อนไขการกรอง</li>
                                        <li>• สรุปภาพรวม (จำนวน/งบประมาณ)</li>
                                        <li>• กราฟสถานะการดำเนินการ</li>
                                        <li>• กราฟงบประมาณตามหน่วยงาน</li>
                                        <li>• ตารางรายละเอียดครบถ้วน</li>
                                        <li>• ข้อมูลวันที่และผู้พิมพ์</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>
        // Encrypted Firebase configuration - DO NOT MODIFY
        const _0x4a7b8c = 'QUl6YVN5QlZXTFJfaXdseDE2Wk90dFRsNGZXSlg4RGpndzJ6UlNFfHByb2N1cmVtZW50LXN1cnZleS5maXJlYmFzZWFwcC5jb218aHR0cHM6Ly9wcm9jdXJlbWVudC1zdXJ2ZXktZGVmYXVsdC1ydGRiLmFzaWEtc291dGhlYXN0MS5maXJlYmFzZWRhdGFiYXNlLmFwcHxwcm9jdXJlbWVudC1zdXJ2ZXl8cHJvY3VyZW1lbnQtc3VydmV5LmZpcmViYXNlc3RvcmFnZS5hcHB8Mzc0OTgxMjMxMTA1fDE6Mzc0OTgxMjMxMTA1OndlYjo4ZTc0MTA1Y2FiNDg1YWRiMjBiNjAwfEctMVYyTFkzQzJLMA==';
        
        // Obfuscated decryption function
        function _0x2f5e9a(_0x1b4c3d) {
            try {
                const _0x8e7f2a = atob(_0x1b4c3d);
                const _0x6d9c1b = _0x8e7f2a.split('|');
                return {
                    apiKey: _0x6d9c1b[0],
                    authDomain: _0x6d9c1b[1],
                    databaseURL: _0x6d9c1b[2],
                    projectId: _0x6d9c1b[3],
                    storageBucket: _0x6d9c1b[4],
                    messagingSenderId: _0x6d9c1b[5],
                    appId: _0x6d9c1b[6],
                    measurementId: _0x6d9c1b[7]
                };
            } catch (_0x3a8b5c) {
                console.error('Configuration error');
                return null;
            }
        }
        
        // Initialize Firebase with obfuscated config
        const firebaseConfig = _0x2f5e9a(_0x4a7b8c);
        if (!firebaseConfig) {
            alert('System initialization failed');
            throw new Error('Config error');
        }

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Additional security measures
        (function() {
            'use strict';
            
            // Disable print functionality
            window.print = function() {
                alert('การพิมพ์ถูกปิดใช้งาน');
                return false;
            };
            
            // Disable image dragging
            document.addEventListener('dragstart', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Clear console periodically
            setInterval(function() {
                console.clear();
                console.log('%cหยุด!', 'color: red; font-size: 50px; font-weight: bold;');
                console.log('%cการเข้าถึงที่นี่อาจไม่ปลอดภัย', 'color: red; font-size: 16px;');
            }, 10000);
            
            // Disable certain DOM methods
            const originalRemoveChild = Node.prototype.removeChild;
            const originalAppendChild = Node.prototype.appendChild;
            const originalInsertBefore = Node.prototype.insertBefore;
            
            Node.prototype.removeChild = function() {
                console.warn('DOM manipulation blocked');
                return null;
            };
            
            // Monitor for suspicious activity
            let suspiciousActivity = 0;
            document.addEventListener('keydown', function(e) {
                // Check for debugging attempts
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                    (e.ctrlKey && e.key === 'u')) {
                    suspiciousActivity++;
                    if (suspiciousActivity > 3) {
                        alert('ตรวจพบความพยายามเข้าถึงระบบที่ไม่ได้รับอนุญาต');
                        window.location.reload();
                    }
                }
            });
            
            // Hide sensitive data in memory
            setTimeout(function() {
                if (window.firebaseConfig) {
                    delete window.firebaseConfig;
                }
                if (window._0x4a7b8c) {
                    delete window._0x4a7b8c;
                }
            }, 5000);
            
            // Advanced console protection
            const _0x9c4e1b = console.log;
            const _0x7f2a8d = console.error;
            const _0x5b3c9e = console.warn;
            const _0x1d6f4a = console.info;
            
            // Override console methods
            console.log = function() { return false; };
            console.error = function() { return false; };
            console.warn = function() { return false; };
            console.info = function() { return false; };
            console.debug = function() { return false; };
            console.trace = function() { return false; };
            console.dir = function() { return false; };
            console.dirxml = function() { return false; };
            console.table = function() { return false; };
            console.group = function() { return false; };
            console.groupCollapsed = function() { return false; };
            console.groupEnd = function() { return false; };
            console.time = function() { return false; };
            console.timeEnd = function() { return false; };
            console.profile = function() { return false; };
            console.profileEnd = function() { return false; };
            console.count = function() { return false; };
            console.assert = function() { return false; };
            
            // Prevent iframe embedding
            if (window.top !== window.self) {
                window.top.location = window.self.location;
            }
            
            // Monitor tab visibility
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.clear();
                }
            });
            
        })();

        // Firebase sync functions
        function saveToFirebase(data, path) {
            return database.ref(path).set(data)
                .then(() => {
                    console.log('✅ Data saved to Firebase successfully');
                    return true;
                })
                .catch((error) => {
                    console.error('❌ Error saving to Firebase:', error);
                    return false;
                });
        }

        function loadFromFirebase(path) {
            return database.ref(path).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    console.log('✅ Data loaded from Firebase successfully');
                    return data;
                })
                .catch((error) => {
                    console.error('❌ Error loading from Firebase:', error);
                    return null;
                });
        }

        function syncSurveyDataToFirebase(data) {
            return saveToFirebase(data, 'surveyData');
        }

        function syncBudgetDataToFirebase(budgets) {
            return saveToFirebase(budgets, 'projectBudgets');
        }

        function saveSurveyToFirebase(surveyItem) {
            // Save individual survey item
            return saveToFirebase(surveyItem, `surveyData/${surveyItem.id}`);
        }

        function loadSurveyDataFromFirebase() {
            return loadFromFirebase('surveyData');
        }

        function loadBudgetDataFromFirebase() {
            return loadFromFirebase('projectBudgets');
        }

        // Real-time listeners for data changes
        function setupRealtimeListeners() {
            // Listen for survey data changes
            database.ref('surveyData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Array.isArray(data)) {
                    surveyData = data;
                    localStorage.setItem('surveyData', JSON.stringify(surveyData));
                    if (document.getElementById('report').classList.contains('active')) {
                        updateReport();
                    }
                    console.log('🔄 Survey data synced from Firebase');
                }
            });

            // Listen for budget data changes
            database.ref('projectBudgets').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.assign(projectBudgets, data);
                    localStorage.setItem('projectBudgets', JSON.stringify(projectBudgets));
                    updateBudgetDisplay();
                    console.log('🔄 Budget data synced from Firebase');
                }
            });
        }

        // Firebase status indicator functions
        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebaseStatus');
            if (!statusElement) return;
            
            statusElement.className = 'mb-4 p-3 rounded-r-lg text-sm border-l-4';
            
            switch(status) {
                case 'connecting':
                    statusElement.className += ' bg-yellow-100 border-yellow-500 text-yellow-700';
                    statusElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-500 mr-2"></div>
                            <span>🔄 ${message}</span>
                        </div>
                    `;
                    break;
                case 'connected':
                    statusElement.className += ' bg-green-100 border-green-500 text-green-700';
                    statusElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            <span>✅ ${message}</span>
                        </div>
                    `;
                    break;
                case 'error':
                    statusElement.className += ' bg-red-100 border-red-500 text-red-700';
                    statusElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                            <span>❌ ${message}</span>
                        </div>
                    `;
                    break;
                case 'offline':
                    statusElement.className += ' bg-gray-100 border-gray-500 text-gray-700';
                    statusElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div>
                            <span>📴 ${message}</span>
                        </div>
                    `;
                    break;
            }
        }

        function hideFirebaseStatus() {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.style.display = 'none';
            }
        }

        // Manual Firebase sync function
        async function manualFirebaseSync() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '🔄 กำลังซิงค์...';
            
            try {
                updateFirebaseStatus('connecting', 'กำลังซิงค์ข้อมูลกับ Firebase...');
                
                // Sync survey data
                const surveySuccess = await syncSurveyDataToFirebase(surveyData);
                
                // Sync budget data
                const budgetSuccess = await syncBudgetDataToFirebase(projectBudgets);
                
                if (surveySuccess && budgetSuccess) {
                    updateFirebaseStatus('connected', 'ซิงค์ข้อมูลสำเร็จ - ข้อมูลล่าสุดถูกบันทึกแล้ว');
                    alert('✅ ซิงค์ข้อมูลกับ Firebase สำเร็จ!\n📊 ข้อมูลการสำรวจ: ' + surveyData.length + ' รายการ\n💰 ข้อมูลงบประมาณ: อัพเดทแล้ว');
                } else {
                    updateFirebaseStatus('error', 'เกิดข้อผิดพลาดบางส่วนในการซิงค์');
                    alert('⚠️ เกิดข้อผิดพลาดบางส่วนในการซิงค์ข้อมูล');
                }
                
                // Hide status after 3 seconds
                setTimeout(() => {
                    hideFirebaseStatus();
                }, 3000);
                
            } catch (error) {
                console.error('Error in manual sync:', error);
                updateFirebaseStatus('error', 'ไม่สามารถซิงค์ข้อมูลได้');
                alert('❌ ไม่สามารถซิงค์ข้อมูลกับ Firebase ได้\nกรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
                
                setTimeout(() => {
                    hideFirebaseStatus();
                }, 5000);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        let itemCounter = 0;
        let surveyData = [];
        
        // Project budget tracking
        const projectBudgets = {
            'โครงการพัฒนาคุณภาพการเรียนการสอน คณะมนุษยศาสตร์และสังคมศาสตร์ (งบแผ่นดิน)': {
                total: 1442200,
                remaining: 1442200
            },
            'โครงการพัฒนาคุณภาพการบริหารจัดการ คณะมนุษยศาสตร์และสังคมศาสตร์ (งบเงินรายได้)': {
                total: 4047748,
                remaining: 4047748
            }
        };

        // Set current date
        document.getElementById('submitDate').value = new Date().toISOString().split('T')[0];

        // Initial budget display update
        setTimeout(() => {
            updateBudgetDisplay();
        }, 100);

        function updateBudgetDisplay() {
            // Project 1: งบแผ่นดิน
            const project1Key = 'โครงการพัฒนาคุณภาพการเรียนการสอน คณะมนุษยศาสตร์และสังคมศาสตร์ (งบแผ่นดิน)';
            const project1Data = projectBudgets[project1Key];
            
            if (project1Data) {
                const project1Used = project1Data.total - project1Data.remaining;
                const project1Percentage = ((project1Used / project1Data.total) * 100).toFixed(1);
                const project1PercentageNum = parseFloat(project1Percentage);
                
                // Update progress bar and percentage
                const project1ProgressBar = document.getElementById('project1ProgressBar');
                const project1PercentageDisplay = document.getElementById('project1Percentage');
                const project1UsedDisplay = document.getElementById('project1Used');
                const project1RemainingDisplay = document.getElementById('project1Remaining');
                const project1RemainingDisplay2 = document.getElementById('project1RemainingDisplay');
                
                if (project1ProgressBar) {
                    // Show progress bar only when there's actual usage
                    if (project1PercentageNum === 0) {
                        project1ProgressBar.style.width = '0%';
                    } else {
                        // Show at least 1% width for visibility when there's usage
                        const displayWidth = project1PercentageNum < 1 ? 1 : project1PercentageNum;
                        project1ProgressBar.style.width = displayWidth + '%';
                    }
                }
                if (project1PercentageDisplay) project1PercentageDisplay.textContent = project1Percentage + '%';
                if (project1UsedDisplay) project1UsedDisplay.textContent = project1Used.toLocaleString('th-TH') + ' บาท';
                if (project1RemainingDisplay) project1RemainingDisplay.textContent = project1Data.remaining.toLocaleString('th-TH') + ' บาท';
                if (project1RemainingDisplay2) project1RemainingDisplay2.textContent = project1Data.remaining.toLocaleString('th-TH') + ' บาท';
                
                // Change progress bar color - always green when there's any usage
                if (project1ProgressBar) {
                    project1ProgressBar.className = 'bg-gradient-to-r from-green-400 to-green-500 h-4 rounded-full transition-all duration-500 ease-out';
                }
            }
            
            // Project 2: งบเงินรายได้
            const project2Key = 'โครงการพัฒนาคุณภาพการบริหารจัดการ คณะมนุษยศาสตร์และสังคมศาสตร์ (งบเงินรายได้)';
            const project2Data = projectBudgets[project2Key];
            
            if (project2Data) {
                const project2Used = project2Data.total - project2Data.remaining;
                const project2Percentage = ((project2Used / project2Data.total) * 100).toFixed(1);
                const project2PercentageNum = parseFloat(project2Percentage);
                
                // Update progress bar and percentage
                const project2ProgressBar = document.getElementById('project2ProgressBar');
                const project2PercentageDisplay = document.getElementById('project2Percentage');
                const project2UsedDisplay = document.getElementById('project2Used');
                const project2RemainingDisplay = document.getElementById('project2Remaining');
                const project2RemainingDisplay2 = document.getElementById('project2RemainingDisplay');
                
                if (project2ProgressBar) {
                    // Show progress bar only when there's actual usage
                    if (project2PercentageNum === 0) {
                        project2ProgressBar.style.width = '0%';
                    } else {
                        // Show at least 1% width for visibility when there's usage
                        const displayWidth = project2PercentageNum < 1 ? 1 : project2PercentageNum;
                        project2ProgressBar.style.width = displayWidth + '%';
                    }
                }
                if (project2PercentageDisplay) project2PercentageDisplay.textContent = project2Percentage + '%';
                if (project2UsedDisplay) project2UsedDisplay.textContent = project2Used.toLocaleString('th-TH') + ' บาท';
                if (project2RemainingDisplay) project2RemainingDisplay.textContent = project2Data.remaining.toLocaleString('th-TH') + ' บาท';
                if (project2RemainingDisplay2) project2RemainingDisplay2.textContent = project2Data.remaining.toLocaleString('th-TH') + ' บาท';
                
                // Change progress bar color - always green when there's any usage
                if (project2ProgressBar) {
                    project2ProgressBar.className = 'bg-gradient-to-r from-green-400 to-green-500 h-4 rounded-full transition-all duration-500 ease-out';
                }
            }
        }

        function deductBudgetFromProject(projectName, amount) {
            if (projectBudgets[projectName]) {
                projectBudgets[projectName].remaining -= amount;
                // Ensure remaining doesn't go below 0
                if (projectBudgets[projectName].remaining < 0) {
                    projectBudgets[projectName].remaining = 0;
                }
                // Save to localStorage
                localStorage.setItem('projectBudgets', JSON.stringify(projectBudgets));
                // Sync to Firebase
                syncBudgetDataToFirebase(projectBudgets);
                updateBudgetDisplay();
            }
        }

        function addBudgetBackToProject(projectName, amount) {
            if (projectBudgets[projectName]) {
                projectBudgets[projectName].remaining += amount;
                // Ensure remaining doesn't exceed total
                if (projectBudgets[projectName].remaining > projectBudgets[projectName].total) {
                    projectBudgets[projectName].remaining = projectBudgets[projectName].total;
                }
                // Save to localStorage
                localStorage.setItem('projectBudgets', JSON.stringify(projectBudgets));
                // Sync to Firebase
                syncBudgetDataToFirebase(projectBudgets);
                updateBudgetDisplay();
            }
        }

        async function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            if (tabName === 'tracking') {
                loadTrackingData();
            }
        }

        function addItem() {
            itemCounter++;
            const tableBody = document.getElementById('itemsTable');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="border border-gray-300 px-3 py-2 text-center">${itemCounter}</td>
                <td class="border border-gray-300 px-3 py-2">
                    <textarea class="w-full p-2 border rounded resize-none" rows="2" placeholder="ระบุรายละเอียด/คุณลักษณะ"></textarea>
                </td>
                <td class="border border-gray-300 px-3 py-2">
                    <textarea class="w-full p-2 border rounded resize-none" rows="2" placeholder="รายละเอียดเพิ่มเติม"></textarea>
                </td>
                <td class="border border-gray-300 px-3 py-2">
                    <select class="w-full p-2 border rounded">
                        <option value="">เลือก</option>
                        <option value="จัดซื้อใหม่">จัดซื้อใหม่</option>
                        <option value="ทดแทน">ทดแทน</option>
                        <option value="เพิ่มเติม">เพิ่มเติม</option>
                        <option value="ซ่อมบำรุง/ปรับปรุง">ซ่อมบำรุง/ปรับปรุง</option>
                    </select>
                </td>
                <td class="border border-gray-300 px-3 py-2">
                    <input type="number" class="w-full p-2 border rounded text-center" min="1" onchange="calculateRowTotal(this)">
                </td>
                <td class="border border-gray-300 px-3 py-2">
                    <input type="text" class="w-full p-2 border rounded text-center" placeholder="หน่วย">
                </td>
                <td class="border border-gray-300 px-3 py-2">
                    <input type="number" class="w-full p-2 border rounded text-center" min="0" step="0.01" onchange="calculateRowTotal(this)">
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center font-medium row-total">0</td>
                <td class="border border-gray-300 px-3 py-2 text-center">
                    <button type="button" onclick="removeItem(this)" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                        🗑️

                </td>
            `;
            tableBody.appendChild(row);
        }

        function removeItem(button) {
            button.closest('tr').remove();
            updateItemNumbers();
            calculateTotal();
        }

        function updateItemNumbers() {
            const rows = document.querySelectorAll('#itemsTable tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
            itemCounter = rows.length;
        }

        function calculateRowTotal(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.cells[4].querySelector('input').value) || 0;
            const unitPrice = parseFloat(row.cells[6].querySelector('input').value) || 0;
            const total = quantity * unitPrice;
            row.cells[7].textContent = total.toLocaleString('th-TH') + ' บาท';
            calculateTotal();
        }

        function calculateTotal() {
            const rows = document.querySelectorAll('#itemsTable tr');
            let total = 0;
            rows.forEach(row => {
                const quantity = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const unitPrice = parseFloat(row.cells[6].querySelector('input').value) || 0;
                total += quantity * unitPrice;
            });
            document.getElementById('totalBudget').textContent = total.toLocaleString('th-TH') + ' บาท';
        }

        // Add initial item
        addItem();

        // File handling functions
        document.getElementById('quotationFile').addEventListener('change', function(e) {
            displaySelectedFiles();
        });

        function displaySelectedFiles() {
            const fileInput = document.getElementById('quotationFile');
            const fileList = document.getElementById('fileList');
            const files = fileInput.files;
            
            fileList.innerHTML = '';
            
            if (files.length > 0) {
                Array.from(files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between bg-gray-50 p-2 rounded border text-sm';
                    
                    const fileInfo = document.createElement('span');
                    fileInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'text-red-500 hover:text-red-700 ml-2';
                    removeBtn.innerHTML = '❌';
                    removeBtn.onclick = () => removeFile(index);
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(removeBtn);
                    fileList.appendChild(fileItem);
                });
            }
        }

        function removeFile(indexToRemove) {
            const fileInput = document.getElementById('quotationFile');
            const dt = new DataTransfer();
            
            Array.from(fileInput.files).forEach((file, index) => {
                if (index !== indexToRemove) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            displaySelectedFiles();
        }

        // Procurement type and item management
        function updateProcurementItems() {
            const procurementType = document.getElementById('procurementType').value;
            const procurementItemSelect = document.getElementById('procurementItem');
            
            // Clear existing options
            procurementItemSelect.innerHTML = '';
            
            if (!procurementType) {
                procurementItemSelect.disabled = true;
                procurementItemSelect.innerHTML = '<option value="">กรุณาเลือกประเภทการจัดหาก่อน</option>';
                return;
            }
            
            procurementItemSelect.disabled = false;
            procurementItemSelect.innerHTML = '<option value="">เลือกพัสดุที่จัดหา</option>';
            
            // Define procurement items by type
            const procurementItems = {
                'ซื้อ': [
                    'วัสดุสำนักงาน',
                    'อุปกรณ์คอมพิวเตอร์',
                    'วัสดุการศึกษา',
                    'เครื่องมือและอุปกรณ์',
                    'วัสดุก่อสร้าง',
                    'วัสดุยานพาหนะ',
                    'วัสดุไฟฟ้า',
                    'วัสดุโทรคมนาคม',
                    'วัสดุวิทยาศาสตร์',
                    'วัสดุการแพทย์',
                    'วัสดุครัว',
                    'วัสดุทำความสะอาด',
                    'ครุภัณฑ์คอมพิวเตอร์',
                    'ครุภัณฑ์สำนักงาน',
                    'ครุภัณฑ์โสตทัศนูปกรณ์',
                    'ครุภัณฑ์วิทยาศาสตร์',
                    'ครุภัณฑ์การแพทย์',
                    'ครุภัณฑ์ยานพาหนะ',
                    'ครุภัณฑ์ก่อสร้าง',
                    'ครุภัณฑ์ครัว',
                    'ครุภัณฑ์ไฟฟ้า',
                    'ครุภัณฑ์ดนตรี',
                    'ครุภัณฑ์กีฬา',
                    'วัสดุอื่นๆ'
                ],
                'จ้าง': [
                    'งานก่อสร้าง',
                    'งานออกแบบ',
                    'งานที่ปรึกษา',
                    'งานวิจัย',
                    'งานฝึกอบรม',
                    'งานสื่อและประชาสัมพันธ์',
                    'งานพัฒนาระบบ',
                    'งานซ่อมบำรุง',
                    'งานขนส่ง',
                    'งานรักษาความปลอดภัย',
                    'งานทำความสะอาด',
                    'งานดูแลภูมิทัศน์',
                    'งานจ้างทำครุภัณฑ์',
                    'งานอื่นๆ'
                ],
                'เช่า': [
                    'เช่าสถานที่',
                    'เช่ายานพาหนะ',
                    'เช่าอุปกรณ์คอมพิวเตอร์',
                    'เช่าอุปกรณ์เสียง',
                    'เช่าอุปกรณ์โสตทัศนูปกรณ์',
                    'เช่าเครื่องจักร',
                    'เช่าเฟอร์นิเจอร์',
                    'เช่าอุปกรณ์งานจัดงาน',
                    'เช่าอุปกรณ์โทรคมนาคม',
                    'เช่าอุปกรณ์การแพทย์',
                    'เช่าอื่นๆ'
                ]
            };
            
            // Add options based on selected type
            if (procurementItems[procurementType]) {
                procurementItems[procurementType].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    procurementItemSelect.appendChild(option);
                });
            }
        }

        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // ตรวจสอบการเลือกระดับความเร่งด่วน
            const urgency = document.querySelector('input[name="urgency"]:checked');
            if (!urgency) {
                alert('❌ กรุณาเลือกระดับความเร่งด่วน');
                return;
            }
            
            // ตรวจสอบการเลือกโครงการ
            const projectSelection = document.getElementById('projectSelection').value;
            if (!projectSelection) {
                alert('❌ กรุณาเลือกโครงการ');
                return;
            }
            
            // ตรวจสอบการเลือกประเภทการจัดหา
            const procurementType = document.getElementById('procurementType').value;
            if (!procurementType) {
                alert('❌ กรุณาเลือกประเภทการจัดหา');
                return;
            }
            
            // ตรวจสอบการเลือกพัสดุที่จัดหา
            const procurementItem = document.getElementById('procurementItem').value;
            if (!procurementItem) {
                alert('❌ กรุณาเลือกพัสดุที่จัดหา');
                return;
            }
            
            const formData = {
                id: Date.now(),
                fullName: document.getElementById('fullName').value,
                department: document.getElementById('department').value,
                submitDate: document.getElementById('submitDate').value,
                projectSelection: projectSelection,
                procurementType: procurementType,
                procurementItem: procurementItem,
                quotationFiles: collectFileInfo(),
                usagePeriod: document.getElementById('usagePeriod').value,
                urgency: urgency.value,
                items: [],
                totalBudget: 0
            };

            // Collect items data
            const rows = document.querySelectorAll('#itemsTable tr');
            let totalBudget = 0;
            
            rows.forEach((row, index) => {
                const item = {
                    no: index + 1,
                    description: row.cells[1].querySelector('textarea').value,
                    note: row.cells[2].querySelector('textarea').value,
                    purpose: row.cells[3].querySelector('select').value,
                    quantity: parseFloat(row.cells[4].querySelector('input').value) || 0,
                    unit: row.cells[5].querySelector('input').value,
                    unitPrice: parseFloat(row.cells[6].querySelector('input').value) || 0,
                    total: (parseFloat(row.cells[4].querySelector('input').value) || 0) * (parseFloat(row.cells[6].querySelector('input').value) || 0)
                };
                formData.items.push(item);
                totalBudget += item.total;
            });

            formData.totalBudget = totalBudget;
            
            // Deduct budget from selected project
            deductBudgetFromProject(projectSelection, totalBudget);
            
            // Save to localStorage
            surveyData.push(formData);
            localStorage.setItem('surveyData', JSON.stringify(surveyData));
            
            // Sync to Firebase
            syncSurveyDataToFirebase(surveyData).then(() => {
                console.log('✅ Survey data synced to Firebase successfully');
                
                alert('✅ บันทึกข้อมูลเรียบร้อยแล้ว!\n📊 บันทึกในเครื่อง: สำเร็จ\n☁️ ซิงค์ Firebase: สำเร็จ\n💰 หักงบประมาณ: ' + totalBudget.toLocaleString('th-TH') + ' บาท\n\n💡 สามารถกดปุ่ม "🖨️ พิมพ์แบบสำรวจ" เพื่อพิมพ์เอกสารได้');
            }).catch((error) => {
                console.error('❌ Failed to sync survey data to Firebase:', error);
                
                alert('⚠️ บันทึกข้อมูลในเครื่องเรียบร้อยแล้ว!\n📊 บันทึกในเครื่อง: สำเร็จ\n☁️ ซิงค์ Firebase: ล้มเหลว (ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต)\n💰 หักงบประมาณ: ' + totalBudget.toLocaleString('th-TH') + ' บาท\n\n💡 สามารถกดปุ่ม "🖨️ พิมพ์แบบสำรวจ" เพื่อพิมพ์เอกสารได้');
            });
        });

        function collectFileInfo() {
            const fileInput = document.getElementById('quotationFile');
            const files = fileInput.files;
            const fileInfoArray = [];
            
            Array.from(files).forEach(file => {
                fileInfoArray.push({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    lastModified: file.lastModified
                });
            });
            
            return fileInfoArray;
        }

        // Chart instances
        let budgetChart = null;
        let purposeChart = null;

        function updateCharts() {
            if (surveyData.length === 0) {
                // Hide charts if no data
                if (budgetChart) {
                    budgetChart.destroy();
                    budgetChart = null;
                }
                if (purposeChart) {
                    purposeChart.destroy();
                    purposeChart = null;
                }
                return;
            }

            updateBudgetChart();
            updatePurposeChart();
        }

        function updateBudgetChart() {
            // Calculate budget by department
            const departmentBudgets = {};
            
            surveyData.forEach(data => {
                const department = data.department;
                if (!departmentBudgets[department]) {
                    departmentBudgets[department] = 0;
                }
                departmentBudgets[department] += data.totalBudget;
            });

            const labels = Object.keys(departmentBudgets);
            const data = Object.values(departmentBudgets);
            const colors = [
                '#3B82F6', // Blue
                '#10B981', // Green
                '#F59E0B', // Yellow
                '#EF4444', // Red
                '#8B5CF6', // Purple
                '#F97316'  // Orange
            ];

            const ctx = document.getElementById('budgetChart').getContext('2d');
            
            if (budgetChart) {
                budgetChart.destroy();
            }

            budgetChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString('th-TH') + ' บาท (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Create custom legend
            let legendHtml = '<div class="grid grid-cols-1 gap-2">';
            labels.forEach((label, index) => {
                const total = data.reduce((a, b) => a + b, 0);
                const percentage = ((data[index] / total) * 100).toFixed(1);
                legendHtml += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded mr-2" style="background-color: ${colors[index]}"></div>
                            <span class="text-sm font-medium">${label}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            ${data[index].toLocaleString('th-TH')} บาท (${percentage}%)
                        </div>
                    </div>
                `;
            });
            legendHtml += '</div>';
            document.getElementById('budgetLegend').innerHTML = legendHtml;
        }

        function updatePurposeChart() {
            // Calculate purpose distribution
            const purposeCounts = {};
            
            surveyData.forEach(data => {
                data.items.forEach(item => {
                    const purpose = item.purpose || 'ไม่ระบุ';
                    if (!purposeCounts[purpose]) {
                        purposeCounts[purpose] = 0;
                    }
                    purposeCounts[purpose]++;
                });
            });

            const labels = Object.keys(purposeCounts);
            const data = Object.values(purposeCounts);
            const colors = [
                '#10B981', // Green
                '#3B82F6', // Blue
                '#F59E0B', // Yellow
                '#EF4444', // Red
                '#8B5CF6', // Purple
                '#F97316'  // Orange
            ];

            const ctx = document.getElementById('purposeChart').getContext('2d');
            
            if (purposeChart) {
                purposeChart.destroy();
            }

            purposeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' รายการ (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Create custom legend
            let legendHtml = '<div class="grid grid-cols-1 gap-2">';
            labels.forEach((label, index) => {
                const total = data.reduce((a, b) => a + b, 0);
                const percentage = ((data[index] / total) * 100).toFixed(1);
                legendHtml += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded mr-2" style="background-color: ${colors[index]}"></div>
                            <span class="text-sm font-medium">${label}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            ${data[index]} รายการ (${percentage}%)
                        </div>
                    </div>
                `;
            });
            legendHtml += '</div>';
            document.getElementById('purposeLegend').innerHTML = legendHtml;
        }

        async function updateReport() {
            const reportContent = document.getElementById('reportContent');
            
            // Show loading indicator
            reportContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p class="text-gray-600">🔄 กำลังโหลดข้อมูลจาก Firebase...</p>
                </div>
            `;
            
            // Try to load latest data from Firebase first
            try {
                console.log('🔄 Loading latest data from Firebase for report...');
                const firebaseSurveyData = await loadSurveyDataFromFirebase();
                if (firebaseSurveyData && Array.isArray(firebaseSurveyData)) {
                    surveyData = firebaseSurveyData;
                    localStorage.setItem('surveyData', JSON.stringify(surveyData));
                    console.log('✅ Latest survey data loaded from Firebase for report');
                }
            } catch (error) {
                console.log('⚠️ Failed to load from Firebase, using localStorage data:', error);
            }
            
            // Fallback to localStorage if Firebase fails
            const savedData = localStorage.getItem('surveyData');
            if (savedData && surveyData.length === 0) {
                surveyData = JSON.parse(savedData);
                console.log('📱 Using localStorage data for report');
            }

            // Check data and display results
            if (surveyData.length === 0) {
                reportContent.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีข้อมูลการสำรวจ กรุณากรอกแบบสำรวจก่อน</p>';
                updateFilterResults(0, 0);
                updateCharts(); // Update charts (will hide them if no data)
                return;
            }

            displayReports(surveyData);
            updateFilterResults(surveyData.length, surveyData.length);
            updateCharts(); // Update charts with current data
        }

        function displayReports(dataToShow) {
            const reportContent = document.getElementById('reportContent');
            
            if (dataToShow.length === 0) {
                reportContent.innerHTML = '<p class="text-gray-500 text-center py-8">ไม่พบข้อมูลที่ตรงกับเงื่อนไขการค้นหา</p>';
                return;
            }

            let html = '<div class="space-y-6">';
            
            dataToShow.forEach((data, index) => {
                // Find original index for edit function
                const originalIndex = surveyData.findIndex(item => item.id === data.id);
                
                html += `
                    <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">รายงานที่ ${originalIndex + 1}</h3>
                                <p class="text-gray-600">ผู้ส่งแบบสำรวจ: ${data.fullName || '-'}</p>
                                <p class="text-gray-600">หน่วยงาน: ${data.department || '-'}</p>
                                <p class="text-gray-600">โครงการ: ${data.projectSelection || '-'}</p>
                                <p class="text-gray-600">ประเภทการจัดหา: ${data.procurementType || '-'}</p>
                                <p class="text-gray-600">พัสดุที่จัดหา: ${data.procurementItem || '-'}</p>
                                <p class="text-gray-600">เอกสารแนบ: ${data.quotationFiles && data.quotationFiles.length > 0 ? data.quotationFiles.length + ' ไฟล์' : 'ไม่มีไฟล์แนบ'}</p>
                                <p class="text-gray-600">วันที่ส่งแบบสำรวจ: ${new Date(data.submitDate).toLocaleDateString('th-TH')}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="requestEditPassword(${originalIndex})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">
                                    ✏️ แก้ไข

                                <button onclick="requestDeletePassword(${originalIndex})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                    🗑️ ลบ

                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse border border-gray-300">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="border border-gray-300 px-2 py-2">ลำดับ</th>
                                        <th class="border border-gray-300 px-2 py-2">รายการ</th>
                                        <th class="border border-gray-300 px-2 py-2">รายละเอียดวัสดุ/งานจ้าง</th>
                                        <th class="border border-gray-300 px-2 py-2">วัตถุประสงค์</th>
                                        <th class="border border-gray-300 px-2 py-2">จำนวน</th>
                                        <th class="border border-gray-300 px-2 py-2">งบประมาณรวม</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.items.forEach(item => {
                    html += `
                        <tr>
                            <td class="border border-gray-300 px-2 py-2 text-center">${item.no || '-'}</td>
                            <td class="border border-gray-300 px-2 py-2">${item.description || '-'}</td>
                            <td class="border border-gray-300 px-2 py-2">${item.note || '-'}</td>
                            <td class="border border-gray-300 px-2 py-2">${item.purpose || '-'}</td>
                            <td class="border border-gray-300 px-2 py-2 text-center">${item.quantity || '-'} ${item.unit || ''}</td>
                            <td class="border border-gray-300 px-2 py-2 text-right">${item.total ? item.total.toLocaleString('th-TH') : '0'} บาท</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                                <tfoot>
                                    <tr class="bg-blue-50 font-bold">
                                        <td colspan="5" class="border border-gray-300 px-2 py-2 text-right">รวมทั้งสิ้น:</td>
                                        <td class="border border-gray-300 px-2 py-2 text-right">${data.totalBudget.toLocaleString('th-TH')} บาท</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="mt-4 text-sm text-gray-600">
                            <p><strong>ช่วงเวลาที่ต้องการใช้งาน:</strong> ${data.usagePeriod}</p>
                            <p><strong>ระดับความเร่งด่วน:</strong> ${data.urgency}</p>
                            <p><strong>งบประมาณที่ใช้:</strong> ${data.totalBudget.toLocaleString('th-TH')} บาท</p>
                            ${data.quotationFiles && data.quotationFiles.length > 0 ? `
                                <div class="mt-3">
                                    <p><strong>ไฟล์แนบ:</strong></p>
                                    <ul class="ml-4 mt-1">
                                        ${data.quotationFiles.map(file => `
                                            <li class="text-xs">• ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            reportContent.innerHTML = html;
        }

        function filterReports() {
            const reportNumber = document.getElementById('filterReportNumber').value.toLowerCase();
            const items = document.getElementById('filterItems').value.toLowerCase();
            const submitter = document.getElementById('filterSubmitter').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value;

            let filteredData = surveyData.filter((data, index) => {
                // Filter by report number
                const reportNumberMatch = reportNumber === '' || (index + 1).toString().includes(reportNumber);
                
                // Filter by items (search in item descriptions)
                const itemsMatch = items === '' || data.items.some(item => 
                    item.description.toLowerCase().includes(items)
                );
                
                // Filter by submitter name
                const submitterMatch = submitter === '' || data.fullName.toLowerCase().includes(submitter);
                
                // Filter by department
                const departmentMatch = department === '' || data.department === department;

                return reportNumberMatch && itemsMatch && submitterMatch && departmentMatch;
            });

            displayReports(filteredData);
            updateFilterResults(filteredData.length, surveyData.length);
            
            // Update charts with filtered data
            const originalData = surveyData;
            surveyData = filteredData; // Temporarily change surveyData for chart update
            updateCharts();
            surveyData = originalData; // Restore original data
        }

        function clearFilters() {
            document.getElementById('filterReportNumber').value = '';
            document.getElementById('filterItems').value = '';
            document.getElementById('filterSubmitter').value = '';
            document.getElementById('filterDepartment').value = '';
            
            displayReports(surveyData);
            updateFilterResults(surveyData.length, surveyData.length);
            updateCharts(); // Update charts with all data
        }

        function updateFilterResults(shown, total) {
            const filterResults = document.getElementById('filterResults');
            if (total === 0) {
                filterResults.innerHTML = '';
            } else {
                filterResults.innerHTML = `แสดง ${shown} จาก ${total} รายการ`;
            }
        }

        function requestEditPassword(index) {
            const password = prompt('🔒 กรุณากรอกรหัสผ่านเพื่อยืนยันการแก้ไขข้อมูล:', '');
            
            if (password === null) {
                // User canceled the prompt
                return;
            }
            
            if (password === '01234') {
                // Correct password
                editSurvey(index);
            } else {
                // Wrong password
                alert('❌ รหัสผ่านไม่ถูกต้อง!\n🚫 ไม่สามารถแก้ไขข้อมูลได้\n📞 กรุณาติดต่อผู้ดูแลระบบหากต้องการแก้ไขข้อมูล');
            }
        }

        function requestDeletePassword(index) {
            const data = surveyData[index];
            const password = prompt('🔒 กรุณากรอกรหัสผ่านเพื่อยืนยันการลบข้อมูล:', '');
            
            if (password === null) {
                // User canceled the prompt
                return;
            }
            
            if (password === '01234') {
                // Correct password - show confirmation dialog
                const confirmation = confirm(
                    `⚠️ ยืนยันการลบข้อมูล?\n\n` +
                    `📄 รายงานของ: ${data.fullName || '-'}\n` +
                    `🏢 หน่วยงาน: ${data.department || '-'}\n` +
                    `💰 งบประมาณ: ${data.totalBudget.toLocaleString('th-TH')} บาท\n\n` +
                    `🚨 การลบไม่สามารถย้อนกลับได้!`
                );
                
                if (confirmation) {
                    deleteSurveyRecord(index);
                }
            } else {
                // Wrong password
                alert('❌ รหัสผ่านไม่ถูกต้อง!\n🚫 ไม่สามารถลบข้อมูลได้\n📞 กรุณาติดต่อผู้ดูแลระบบหากต้องการลบข้อมูล');
            }
        }

        function deleteSurveyRecord(index) {
            const data = surveyData[index];
            
            // Add budget back to the project before deleting
            if (data.projectSelection && data.totalBudget) {
                addBudgetBackToProject(data.projectSelection, data.totalBudget);
            }
            
            // Remove from surveyData
            surveyData.splice(index, 1);
            localStorage.setItem('surveyData', JSON.stringify(surveyData));
            
            // Sync to Firebase
            syncSurveyDataToFirebase(surveyData).then(() => {
                console.log('✅ Survey data synced to Firebase after deletion');
            }).catch((error) => {
                console.error('❌ Failed to sync survey data to Firebase after deletion:', error);
            });
            
            // Update the report display
            updateReport();
            
            alert('✅ ลบข้อมูลเรียบร้อยแล้ว!\n💰 เงินงบประมาณถูกคืนกลับโครงการแล้ว');
        }

        function editSurvey(index) {
            const data = surveyData[index];
            
            // Add budget back to the project before editing
            if (data.projectSelection && data.totalBudget) {
                addBudgetBackToProject(data.projectSelection, data.totalBudget);
            }
            
            // Fill form with existing data
            document.getElementById('fullName').value = data.fullName;
            document.getElementById('department').value = data.department;
            document.getElementById('submitDate').value = data.submitDate;
            document.getElementById('projectSelection').value = data.projectSelection || '';
            document.getElementById('procurementType').value = data.procurementType || '';
            
            // Update procurement items based on type and set value
            if (data.procurementType) {
                updateProcurementItems();
                // Use setTimeout to ensure the options are loaded before setting value
                setTimeout(() => {
                    document.getElementById('procurementItem').value = data.procurementItem || '';
                }, 100);
            }
            
            document.getElementById('quotationFile').value = ''; // Clear file input
            document.getElementById('fileList').innerHTML = ''; // Clear file list
            document.getElementById('usagePeriod').value = data.usagePeriod;
            
            if (data.urgency) {
                document.querySelector(`input[name="urgency"][value="${data.urgency}"]`).checked = true;
            }
            
            // Clear existing items
            document.getElementById('itemsTable').innerHTML = '';
            itemCounter = 0;
            
            // Add items from saved data
            data.items.forEach(item => {
                addItem();
                const lastRow = document.querySelector('#itemsTable tr:last-child');
                lastRow.cells[1].querySelector('textarea').value = item.description;
                lastRow.cells[2].querySelector('textarea').value = item.note;
                lastRow.cells[3].querySelector('select').value = item.purpose;
                lastRow.cells[4].querySelector('input').value = item.quantity;
                lastRow.cells[5].querySelector('input').value = item.unit;
                lastRow.cells[6].querySelector('input').value = item.unitPrice;
                calculateRowTotal(lastRow.cells[4].querySelector('input'));
            });
            
            // Remove from surveyData for re-submission
            surveyData.splice(index, 1);
            localStorage.setItem('surveyData', JSON.stringify(surveyData));
            
            // Sync to Firebase
            syncSurveyDataToFirebase(surveyData).then(() => {
                console.log('✅ Survey data synced to Firebase after edit');
            }).catch((error) => {
                console.error('❌ Failed to sync survey data to Firebase after edit:', error);
            });
            
            // Switch to survey tab
            switchTab('survey');
            
            alert('📝 ข้อมูลถูกโหลดเพื่อแก้ไขแล้ว กรุณาทำการแก้ไขและบันทึกใหม่');
        }

        function printCurrentSurvey() {
            // Collect current form data
            const fullName = document.getElementById('fullName').value;
            const department = document.getElementById('department').value;
            const submitDate = document.getElementById('submitDate').value;
            const projectSelection = document.getElementById('projectSelection').value;
            const procurementType = document.getElementById('procurementType').value;
            const procurementItem = document.getElementById('procurementItem').value;
            const quotationFiles = collectFileInfo();
            const usagePeriod = document.getElementById('usagePeriod').value;
            const urgencyElement = document.querySelector('input[name="urgency"]:checked');
            const urgency = urgencyElement ? urgencyElement.value : '';

            // Validate required fields
            if (!fullName || !department) {
                alert('❌ กรุณากรอกข้อมูลผู้ตอบแบบสำรวจและหน่วยงานก่อนพิมพ์');
                return;
            }
            
            // ตรวจสอบการเลือกโครงการ
            if (!projectSelection) {
                alert('❌ กรุณาเลือกโครงการก่อนพิมพ์');
                return;
            }
            
            // ตรวจสอบการเลือกประเภทการจัดหา
            if (!procurementType) {
                alert('❌ กรุณาเลือกประเภทการจัดหาก่อนพิมพ์');
                return;
            }
            
            // ตรวจสอบการเลือกพัสดุที่จัดหา
            if (!procurementItem) {
                alert('❌ กรุณาเลือกพัสดุที่จัดหาก่อนพิมพ์');
                return;
            }
            
            // ตรวจสอบการเลือกระดับความเร่งด่วน
            if (!urgencyElement) {
                alert('❌ กรุณาเลือกระดับความเร่งด่วนก่อนพิมพ์');
                return;
            }

            // Collect items data
            const rows = document.querySelectorAll('#itemsTable tr');
            let items = [];
            let totalBudget = 0;
            
            rows.forEach((row, index) => {
                const description = row.cells[1].querySelector('textarea').value;
                const note = row.cells[2].querySelector('textarea').value;
                const purpose = row.cells[3].querySelector('select').value;
                const quantity = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const unit = row.cells[5].querySelector('input').value;
                const unitPrice = parseFloat(row.cells[6].querySelector('input').value) || 0;
                const total = quantity * unitPrice;

                // Only include items with description
                if (description.trim()) {
                    items.push({
                        no: items.length + 1,
                        description: description,
                        note: note,
                        purpose: purpose,
                        quantity: quantity,
                        unit: unit,
                        unitPrice: unitPrice,
                        total: total
                    });
                    totalBudget += total;
                }
            });

            if (items.length === 0) {
                alert('❌ กรุณากรอกรายการอย่างน้อย 1 รายการก่อนพิมพ์');
                return;
            }

            // Create print content
            const printContent = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>แบบสำรวจความต้องการพัสดุ พ.ศ. 2569</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: 'Sarabun', sans-serif;
                            font-size: 14px;
                            line-height: 1.5;
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #2563eb;
                            padding-bottom: 15px;
                        }
                        .header h1 {
                            font-size: 18px;
                            font-weight: bold;
                            margin: 0 0 5px 0;
                            color: #1e40af;
                        }
                        .header p {
                            margin: 2px 0;
                            font-size: 14px;
                            color: #64748b;
                        }
                        .section {
                            margin-bottom: 25px;
                        }
                        .section-title {
                            font-weight: bold;
                            font-size: 16px;
                            margin-bottom: 15px;
                            color: #1e40af;
                            border-bottom: 1px solid #e5e7eb;
                            padding-bottom: 5px;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                            margin-bottom: 20px;
                        }
                        .info-item {
                            margin-bottom: 10px;
                        }
                        .info-label {
                            font-weight: 600;
                            color: #374151;
                            margin-bottom: 3px;
                        }
                        .info-value {
                            padding: 5px 10px;
                            background-color: #f8fafc;
                            border: 1px solid #e5e7eb;
                            border-radius: 4px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            font-size: 12px;
                        }
                        th, td {
                            border: 1px solid #d1d5db;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f3f4f6;
                            font-weight: 600;
                            text-align: center;
                        }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .total-row {
                            background-color: #eff6ff;
                            font-weight: bold;
                        }
                        .print-date {
                            text-align: right;
                            font-size: 12px;
                            color: #6b7280;
                            margin-top: 20px;
                            border-top: 1px solid #e5e7eb;
                            padding-top: 10px;
                        }
                        .no-print {
                            margin: 20px 0;
                            text-align: center;
                        }
                        .print-btn {
                            background-color: #059669;
                            color: white;
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                            margin-right: 10px;
                        }
                        .close-btn {
                            background-color: #6b7280;
                            color: white;
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>แบบสำรวจความต้องการพัสดุ (จัดซื้อ/จัดจ้าง)</h1>
                        <p>ประจำปีงบประมาณ พ.ศ. 2569</p>
                        <p>คณะมนุษยศาสตร์และสังคมศาสตร์ มหาวิทยาลัยราชภัฏสุราษฎร์ธานี</p>
                    </div>

                    <div class="section">
                        <div class="section-title">ส่วนที่ 1: ข้อมูลผู้ตอบแบบสำรวจ</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">ชื่อ-สกุล ผู้ตอบแบบสำรวจ:</div>
                                <div class="info-value">${fullName || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">หน่วยงาน/ฝ่าย:</div>
                                <div class="info-value">${department || '-'}</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">โครงการ:</div>
                            <div class="info-value">${projectSelection || '-'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ประเภทการจัดหา:</div>
                            <div class="info-value">${procurementType || '-'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">พัสดุที่จัดหา:</div>
                            <div class="info-value">${procurementItem || '-'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">วันที่กรอกข้อมูล:</div>
                            <div class="info-value">${submitDate ? new Date(submitDate).toLocaleDateString('th-TH', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            }) : '-'}</div>
                        </div>
                        ${quotationFiles.length > 0 ? `
                            <div class="info-item">
                                <div class="info-label">ไฟล์แนบใบเสนอราคา:</div>
                                <div class="info-value">
                                    ${quotationFiles.map(file => `• ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`).join('<br>')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="section">
                        <div class="section-title">ส่วนที่ 2: รายการที่ต้องการจัดซื้อ/จัดจ้าง</div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 5%">ลำดับ</th>
                                    <th style="width: 25%">รายการ</th>
                                    <th style="width: 20%">รายละเอียดวัสดุ/งานจ้าง</th>
                                    <th style="width: 12%">วัตถุประสงค์</th>
                                    <th style="width: 8%">จำนวน</th>
                                    <th style="width: 8%">หน่วยนับ</th>
                                    <th style="width: 10%">งบประมาณ/รายการ</th>
                                    <th style="width: 12%">งบประมาณรวม</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td class="text-center">${item.no || '-'}</td>
                                        <td>${item.description || '-'}</td>
                                        <td>${item.note || '-'}</td>
                                        <td class="text-center">${item.purpose || '-'}</td>
                                        <td class="text-center">${item.quantity ? item.quantity.toLocaleString('th-TH') : '0'}</td>
                                        <td class="text-center">${item.unit || '-'}</td>
                                        <td class="text-right">${item.unitPrice ? item.unitPrice.toLocaleString('th-TH') : '0'}</td>
                                        <td class="text-right">${item.total ? item.total.toLocaleString('th-TH') : '0'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="7" class="text-right"><strong>รวมทั้งสิ้น:</strong></td>
                                    <td class="text-right"><strong>${totalBudget.toLocaleString('th-TH')} บาท</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="section">
                        <div class="section-title">ส่วนที่ 3: ระยะเวลาที่ต้องการใช้งานและความเร่งด่วน</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">ช่วงเวลาที่ต้องการใช้งานพัสดุ:</div>
                                <div class="info-value">${usagePeriod || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ระดับความเร่งด่วน:</div>
                                <div class="info-value">${urgency || '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">                                          
                        <div style="padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; background-color: #f9fafb;">
                            <div style="text-align: center;">
                                <div class="info-label" style="margin-bottom: 15px;">ลงชื่อ</div>
                                <div style="border-bottom: 1px solid #333; width: 350px; height: 40px; margin: 10px auto;"></div>
                                <div style="font-size: 14px; margin-top: 10px;">(${fullName || '..................................................................'})</div>
                                <div style="font-size: 12px; margin-top: 5px; color: #6b7280;">ผู้ขอซื้อจ้าง</div>
                                <div style="margin-top: 20px;">
                                    <div class="info-label" style="display: inline-block; margin-right: 15px;">วันที่</div>
                                    <div style="display: inline-block; font-size: 14px;">${new Date().toLocaleDateString('th-TH', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric'
                                    })}</div>
                                </div>
                            </div>
                        </div>
                    

                    <div class="section">
                        <div class="section-title">ส่วนการอนุมัติและลงนาม</div>
                        
                        <!-- ฝ่ายพัสดุ -->
                        <div class="approval-section" style="margin-bottom: 25px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <div class="info-label">ฝ่ายพัสดุ - วันที่รับเอกสารสำหรับดำเนินการ:</div>
                                    <div style="border-bottom: 1px solid #333; width: 200px; height: 25px; margin-top: 5px;"></div>
                                </div>
                                <div style="text-align: center; margin-left: 30px;">
                                    <div class="info-label">ลงชื่อ</div>
                                    <div style="border-bottom: 1px solid #333; width: 200px; height: 40px; margin: 10px auto;"></div>
                                    <div style="font-size: 12px;">(นางสาวอธิฐาน ศรีสวัสดิ์)</div>
                                    <div style="font-size: 12px; margin-top: 5px;">เจ้าหน้าที่ฝ่ายพัสดุ คณะมนุษยศาสตร์และสังคมศาสตร์</div>
                                </div>
                            </div>
                        </div>

                        <!-- ฝ่ายแผนและงบประมาณ -->
                        <div class="approval-section" style="margin-bottom: 25px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <div class="info-label" style="margin-bottom: 15px; font-size: 14px;">ฝ่ายแผนและงบประมาณ - ตรวจสอบงบประมาณ</div>
                            
                            <!-- ตารางตรวจสอบงบประมาณ -->
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #333; padding: 8px; text-align: center; width: 30%;">รายการ</th>
                                        <th style="border: 1px solid #333; padding: 8px; text-align: center; width: 35%;">งบลงทุน (บาท)</th>
                                        <th style="border: 1px solid #333; padding: 8px; text-align: center; width: 35%;">งบดำเนินการ (บาท)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 8px;">งบประมาณของหน่วยงานทั้งหมด</td>
                                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">
                                            <div style="border-bottom: 1px solid #333; height: 25px; width: 100%;"></div>
                                        </td>
                                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">
                                            <div style="border-bottom: 1px solid #333; height: 25px; width: 100%;"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 8px;">ขออนุมัติครั้งนี้</td>
                                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">
                                            <div style="border-bottom: 1px solid #333; height: 25px; width: 100%;"></div>
                                        </td>
                                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">
                                            <div style="border-bottom: 1px solid #333; height: 25px; width: 100%;"></div>
                                        </td>
                                    </tr>
                                    <tr style="background-color: #f0f8ff;">
                                        <td style="border: 1px solid #333; padding: 8px; font-weight: bold;">คงเหลือ</td>
                                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">
                                            <div style="border-bottom: 1px solid #333; height: 25px; width: 100%;"></div>
                                        </td>
                                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">
                                            <div style="border-bottom: 1px solid #333; height: 25px; width: 100%;"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- ลงชื่อ -->
                            <div style="text-align: center; margin-top: 20px;">
                                <div class="info-label">ลงชื่อ</div>
                                <div style="border-bottom: 1px solid #333; width: 200px; height: 40px; margin: 10px auto;"></div>
                                <div style="font-size: 12px;">(นางสาวธิติภรณ์ แสงทอง)</div>
                                <div style="font-size: 12px; margin-top: 5px;">เจ้าหน้าที่ฝ่ายแผนและงบประมาณ</div>
                                <div style="margin-top: 10px;">
                                    <span>วันที่ ......../......../............</span>
                                </div>
                            </div>
                        </div>

                        <!-- หัวหน้าสำนักงานคณบดี -->
                        <div class="approval-section" style="margin-bottom: 25px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <div class="info-label" style="margin-bottom: 15px;">ความเห็นของหัวหน้าสำนักงานคณบดี:</div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="margin-right: 30px; display: inline-block;">
                                    <input type="checkbox" style="margin-right: 8px;"> อนุมัติ
                                </label>
                                <label style="display: inline-block;">
                                    <input type="checkbox" style="margin-right: 8px;"> ไม่อนุมัติ
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div class="info-label">เหตุผล:</div>
                                <div style="border: 1px solid #333; min-height: 60px; margin-top: 5px; padding: 10px;">
                                    <div style="border-bottom: 1px dotted #ccc; height: 20px; margin-bottom: 5px;"></div>
                                    <div style="border-bottom: 1px dotted #ccc; height: 20px; margin-bottom: 5px;"></div>
                                    <div style="border-bottom: 1px dotted #ccc; height: 20px;"></div>
                                </div>
                            </div>
                            
                            <div style="text-align: center;">
                                <div class="info-label">ลงชื่อ</div>
                                <div style="border-bottom: 1px solid #333; width: 250px; height: 40px; margin: 10px auto;"></div>
                                <div style="font-size: 12px;">(นางเพ็ญแก้ว พิมาน)</div>
                                <div style="font-size: 12px; margin-top: 5px;">หัวหน้าสำนักงานคณบดี</div>
                                <div style="margin-top: 15px;">
                                    <span style="margin-right: 30px;">วันที่ ......../......../............</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="print-date">
                        พิมพ์เมื่อ: ${new Date().toLocaleDateString('th-TH', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>

                    <div class="no-print">
                        <button class="print-btn" onclick="window.print()">🖨️ พิมพ์</button>
                        <button class="close-btn" onclick="window.close()">❌ ปิดหน้าต่าง</button>
                    </div>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
        }

        function printJobDetails() {
            // Collect current form data
            const fullName = document.getElementById('fullName').value;
            const department = document.getElementById('department').value;
            const projectSelection = document.getElementById('projectSelection').value;
            const procurementType = document.getElementById('procurementType').value;
            const procurementItem = document.getElementById('procurementItem').value;

            // Validate required fields
            if (!fullName || !department) {
                alert('❌ กรุณากรอกข้อมูลผู้ตอบแบบสำรวจและหน่วยงานก่อนพิมพ์');
                return;
            }
            
            if (!projectSelection) {
                alert('❌ กรุณาเลือกโครงการก่อนพิมพ์');
                return;
            }
            
            if (!procurementType) {
                alert('❌ กรุณาเลือกประเภทการจัดหาก่อนพิมพ์');
                return;
            }
            
            if (!procurementItem) {
                alert('❌ กรุณาเลือกพัสดุที่จัดหาก่อนพิมพ์');
                return;
            }

            // Collect items data
            const rows = document.querySelectorAll('#itemsTable tr');
            let items = [];
            
            rows.forEach((row, index) => {
                const description = row.cells[1].querySelector('textarea').value;
                const note = row.cells[2].querySelector('textarea').value;
                const purpose = row.cells[3].querySelector('select').value;
                const quantity = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const unit = row.cells[5].querySelector('input').value;

                // Only include items with description
                if (description.trim()) {
                    items.push({
                        no: items.length + 1,
                        description: description,
                        note: note,
                        purpose: purpose,
                        quantity: quantity,
                        unit: unit
                    });
                }
            });

            if (items.length === 0) {
                alert('❌ กรุณากรอกรายการอย่างน้อย 1 รายการก่อนพิมพ์');
                return;
            }

            // Create print content for job details
            const printContent = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>รายละเอียดงาน</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: 'Sarabun', sans-serif;
                            font-size: 14px;
                            line-height: 1.6;
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #2563eb;
                            padding-bottom: 15px;
                        }
                        .header h1 {
                            font-size: 20px;
                            font-weight: bold;
                            margin: 0 0 10px 0;
                            color: #1e40af;
                        }
                        .project-info {
                            background: #f8fafc;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 25px;
                            border: 1px solid #e5e7eb;
                        }
                        .project-info h2 {
                            font-size: 16px;
                            font-weight: bold;
                            margin: 0 0 15px 0;
                            color: #1e40af;
                        }
                        .info-row {
                            display: flex;
                            margin-bottom: 8px;
                        }
                        .info-label {
                            font-weight: 600;
                            width: 150px;
                            color: #374151;
                        }
                        .info-value {
                            flex: 1;
                            color: #111827;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            font-size: 13px;
                        }
                        th, td {
                            border: 1px solid #374151;
                            padding: 10px 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f3f4f6;
                            font-weight: bold;
                            text-align: center;
                            color: #374151;
                        }
                        .text-center { text-align: center; }
                        .footer {
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 1px solid #e5e7eb;
                            text-align: right;
                            color: #6b7280;
                            font-size: 12px;
                        }
                        .print-btn, .close-btn {
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin: 5px;
                            font-size: 14px;
                            font-family: 'Sarabun', sans-serif;
                        }
                        .close-btn {
                            background: #ef4444;
                        }
                        .print-btn:hover {
                            background: #2563eb;
                        }
                        .close-btn:hover {
                            background: #dc2626;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>รายละเอียดงาน</h1>
                        <p>คณะมนุษยศาสตร์และสังคมศาสตร์ มหาวิทยาลัยราชภัฏสุราษฎร์ธานี</p>
                    </div>

                    <div class="project-info">
                        <h2>ข้อมูลโครงการ</h2>
                        <div class="info-row">
                            <div class="info-label">ชื่อโครงการ:</div>
                            <div class="info-value">${projectSelection}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ประเภทการจัดหา:</div>
                            <div class="info-value">${procurementType}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">พัสดุที่จัดหา:</div>
                            <div class="info-value">${procurementItem}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ผู้กำหนดรายละเอียด:</div>
                            <div class="info-value">${fullName || '-'} (${department || '-'})</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 8%;">ลำดับ</th>
                                <th style="width: 25%;">รายการ</th>
                                <th style="width: 30%;">รายละเอียดวัสดุ/งานจ้าง</th>
                                <th style="width: 17%;">วัตถุประสงค์</th>
                                <th style="width: 10%;">จำนวน</th>
                                <th style="width: 10%;">หน่วยนับ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td class="text-center">${item.no || '-'}</td>
                                    <td>${item.description || '-'}</td>
                                    <td>${item.note || '-'}</td>
                                    <td class="text-center">${item.purpose || '-'}</td>
                                    <td class="text-center">${item.quantity || '0'}</td>
                                    <td class="text-center">${item.unit || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="footer">
                        พิมพ์เมื่อ: ${new Date().toLocaleDateString('th-TH', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>

                    <div class="no-print">
                        <button class="print-btn" onclick="window.print()">🖨️ พิมพ์</button>
                        <button class="close-btn" onclick="window.close()">❌ ปิดหน้าต่าง</button>
                    </div>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
        }

        function printReport() {
            // Get current filtered data
            const filteredData = getCurrentFilteredData();
            
            if (filteredData.length === 0) {
                alert('❌ ไม่มีข้อมูลสำหรับพิมพ์ หรือข้อมูลถูกกรองหมดแล้ว');
                return;
            }

            // Calculate summary data
            const totalBudget = filteredData.reduce((sum, data) => sum + data.totalBudget, 0);
            const departments = [...new Set(filteredData.map(data => data.department))];
            const purposes = {};
            const departmentBudgets = {};
            
            filteredData.forEach(data => {
                const dept = data.department;
                departmentBudgets[dept] = (departmentBudgets[dept] || 0) + data.totalBudget;
                
                data.items.forEach(item => {
                    const purpose = item.purpose || 'ไม่ระบุ';
                    purposes[purpose] = (purposes[purpose] || 0) + 1;
                });
            });

            // Create print content
            const printContent = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>รายงานข้อมูลการสำรวจพัสดุ ปี 2569</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        @media print {
                            body { margin: 0; padding: 15mm; }
                            .no-print { display: none; }
                            .page-break { page-break-before: always; }
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                        }
                        body {
                            font-family: 'Sarabun', sans-serif;
                            font-size: 12px;
                            line-height: 1.4;
                            color: #333;
                            max-width: 210mm;
                            margin: 0 auto;
                            padding: 15mm;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #2563eb;
                            padding-bottom: 15px;
                        }
                        .header h1 {
                            font-size: 18px;
                            font-weight: bold;
                            margin: 0 0 5px 0;
                            color: #1e40af;
                        }
                        .header p {
                            margin: 2px 0;
                            font-size: 12px;
                            color: #64748b;
                        }
                        .summary-section {
                            background-color: #f8fafc;
                            border: 1px solid #e2e8f0;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                        }
                        .summary-title {
                            font-weight: bold;
                            font-size: 14px;
                            margin-bottom: 10px;
                            color: #1e40af;
                        }
                        .summary-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                        }
                        .chart-section {
                            margin-bottom: 20px;
                        }
                        .chart-title {
                            font-weight: bold;
                            font-size: 13px;
                            margin-bottom: 8px;
                            color: #1f2937;
                        }
                        .chart-item {
                            margin-bottom: 4px;
                            padding: 2px 0;
                            font-size: 11px;
                        }
                        .data-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            font-size: 10px;
                        }
                        .data-table th, .data-table td {
                            border: 1px solid #d1d5db;
                            padding: 6px;
                            text-align: left;
                        }
                        .data-table th {
                            background-color: #f3f4f6;
                            font-weight: 600;
                            text-align: center;
                        }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .total-row {
                            background-color: #eff6ff;
                            font-weight: bold;
                        }
                        .detail-section {
                            margin-bottom: 15px;
                            border: 1px solid #e5e7eb;
                            border-radius: 6px;
                            padding: 10px;
                        }
                        .detail-header {
                            font-weight: bold;
                            margin-bottom: 8px;
                            color: #1f2937;
                        }
                        .detail-info {
                            font-size: 11px;
                            margin-bottom: 3px;
                        }
                        .print-date {
                            text-align: right;
                            font-size: 10px;
                            color: #6b7280;
                            margin-top: 20px;
                            border-top: 1px solid #e5e7eb;
                            padding-top: 10px;
                        }
                        .no-print {
                            margin: 20px 0;
                            text-align: center;
                        }
                        .print-btn {
                            background-color: #059669;
                            color: white;
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                            margin-right: 10px;
                        }
                        .close-btn {
                            background-color: #6b7280;
                            color: white;
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>รายงานข้อมูลการสำรวจพัสดุ (จัดซื้อ/จัดจ้าง)</h1>
                        <p>ประจำปีงบประมาณ พ.ศ. 2569</p>
                        <p>คณะมนุษยศาสตร์และสังคมศาสตร์ มหาวิทยาลัยราชภัฏสุราษฎร์ธานี</p>
                        <p>สร้างเมื่อ: ${new Date().toLocaleDateString('th-TH')} | เงื่อนไข: ${getFilterInfo()}</p>
                    </div>

                    <div class="summary-section">
                        <div class="summary-title">สรุปข้อมูลโดยรวม</div>
                        <div class="summary-grid">
                            <div>
                                <div class="detail-info"><strong>จำนวนรายการ:</strong> ${filteredData.length} รายการ</div>
                                <div class="detail-info"><strong>จำนวนหน่วยงาน:</strong> ${departments.length} หน่วยงาน</div>
                            </div>
                            <div>
                                <div class="detail-info"><strong>งบประมาณรวม:</strong> ${totalBudget.toLocaleString('th-TH')} บาท</div>
                                <div class="detail-info"><strong>วัตถุประสงค์:</strong> ${Object.keys(purposes).length} ประเภท</div>
                            </div>
                        </div>
                    </div>

                    <div class="summary-grid">
                        <div class="chart-section">
                            <div class="chart-title">📊 สัดส่วนงบประมาณตามหน่วยงาน</div>
                            ${Object.entries(departmentBudgets).map(([dept, budget]) => {
                                const percentage = ((budget / totalBudget) * 100).toFixed(1);
                                return `<div class="chart-item">• ${dept}: ${budget.toLocaleString('th-TH')} บาท (${percentage}%)</div>`;
                            }).join('')}
                        </div>
                        <div class="chart-section">
                            <div class="chart-title">🎯 สัดส่วนวัตถุประสงค์</div>
                            ${Object.entries(purposes).map(([purpose, count]) => {
                                const totalItems = Object.values(purposes).reduce((sum, c) => sum + c, 0);
                                const percentage = ((count / totalItems) * 100).toFixed(1);
                                return `<div class="chart-item">• ${purpose}: ${count} รายการ (${percentage}%)</div>`;
                            }).join('')}
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <div class="summary-title">รายละเอียดข้อมูล</div>
                        ${filteredData.map((data, index) => `
                            <div class="detail-section">
                                <div class="detail-header">${index + 1}. ${data.fullName || '-'} (${data.department || '-'})</div>
                                <div class="detail-info">โครงการ: ${data.projectSelection || '-'}</div>
                                <div class="detail-info">ประเภทการจัดหา: ${data.procurementType || '-'}</div>
                                <div class="detail-info">พัสดุที่จัดหา: ${data.procurementItem || '-'}</div>
                                <div class="detail-info">วันที่ส่ง: ${new Date(data.submitDate).toLocaleDateString('th-TH')}</div>
                                <div class="detail-info">ความเร่งด่วน: ${data.urgency || '-'}</div>
                                
                                <table class="data-table" style="margin-top: 8px;">
                                    <thead>
                                        <tr>
                                            <th>รายการ</th>
                                            <th>วัตถุประสงค์</th>
                                            <th>จำนวน</th>
                                            <th>งบประมาณ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.items.map(item => `
                                            <tr>
                                                <td>${item.description || '-'}</td>
                                                <td class="text-center">${item.purpose || '-'}</td>
                                                <td class="text-center">${item.quantity || '0'} ${item.unit || ''}</td>
                                                <td class="text-right">${item.total ? item.total.toLocaleString('th-TH') : '0'} บาท</td>
                                            </tr>
                                        `).join('')}
                                        <tr class="total-row">
                                            <td colspan="3" class="text-right"><strong>รวมทั้งสิ้น:</strong></td>
                                            <td class="text-right"><strong>${data.totalBudget.toLocaleString('th-TH')} บาท</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        `).join('')}
                    </div>

                    <div class="print-date">
                        พิมพ์เมื่อ: ${new Date().toLocaleDateString('th-TH', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>

                    <div class="no-print">
                        <button class="print-btn" onclick="window.print()">🖨️ พิมพ์</button>
                        <button class="close-btn" onclick="window.close()">❌ ปิดหน้าต่าง</button>
                    </div>
                </body>
                </html>
            `;

            // Open print window with A4 size
            const printWindow = window.open('', '', 'width=794,height=1123');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
        }
        
        function getCurrentFilteredData() {
            const reportNumber = document.getElementById('filterReportNumber').value.toLowerCase();
            const items = document.getElementById('filterItems').value.toLowerCase();
            const submitter = document.getElementById('filterSubmitter').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value;

            return surveyData.filter((data, index) => {
                const reportNumberMatch = reportNumber === '' || (index + 1).toString().includes(reportNumber);
                const itemsMatch = items === '' || data.items.some(item => 
                    item.description.toLowerCase().includes(items)
                );
                const submitterMatch = submitter === '' || data.fullName.toLowerCase().includes(submitter);
                const departmentMatch = department === '' || data.department === department;

                return reportNumberMatch && itemsMatch && submitterMatch && departmentMatch;
            });
        }
        
        function getFilterInfo() {
            const filters = [];
            const reportNumber = document.getElementById('filterReportNumber').value;
            const items = document.getElementById('filterItems').value;
            const submitter = document.getElementById('filterSubmitter').value;
            const department = document.getElementById('filterDepartment').value;
            
            if (reportNumber) filters.push(`เลขที่: ${reportNumber}`);
            if (items) filters.push(`รายการ: ${items}`);
            if (submitter) filters.push(`ผู้ส่ง: ${submitter}`);
            if (department) filters.push(`หน่วยงาน: ${department}`);
            
            return filters.length > 0 ? filters.join(', ') : 'ทั้งหมด';
        }

        function deleteReports(startIndex, endIndex) {
            // Delete reports from startIndex to endIndex (0-based indexing)
            const savedData = localStorage.getItem('surveyData');
            if (savedData) {
                surveyData = JSON.parse(savedData);
                
                // Remove items from startIndex to endIndex
                surveyData.splice(startIndex, endIndex - startIndex + 1);
                
                // Save back to localStorage
                localStorage.setItem('surveyData', JSON.stringify(surveyData));
                
                // Sync to Firebase
                syncSurveyDataToFirebase(surveyData).then(() => {
                    console.log('✅ Survey data synced to Firebase after deletion');
                }).catch((error) => {
                    console.error('❌ Failed to sync survey data to Firebase after deletion:', error);
                });
                
                // Update the report display
                updateReport();
                
                console.log(`ลบรายงานที่ ${startIndex + 1} ถึง ${endIndex + 1} เรียบร้อยแล้ว`);
                alert(`✅ ลบรายงานที่ ${startIndex + 1} ถึง ${endIndex + 1} เรียบร้อยแล้ว`);
            }
        }

        // Load saved data on page load
        window.addEventListener('load', async function() {
            updateFirebaseStatus('connecting', 'กำลังเชื่อมต่อกับฐานข้อมูล Firebase...');
            
            // Setup real-time listeners first
            setupRealtimeListeners();
            
            // Try to load data from Firebase first
            try {
                console.log('🔄 Loading data from Firebase...');
                updateFirebaseStatus('connecting', 'กำลังโหลดข้อมูลจาก Firebase...');
                
                // Load survey data from Firebase
                const firebaseSurveyData = await loadSurveyDataFromFirebase();
                if (firebaseSurveyData && Array.isArray(firebaseSurveyData)) {
                    surveyData = firebaseSurveyData;
                    localStorage.setItem('surveyData', JSON.stringify(surveyData));
                    console.log('✅ Survey data loaded from Firebase');
                } else {
                    // Fallback to localStorage
                    const savedData = localStorage.getItem('surveyData');
                    if (savedData) {
                        surveyData = JSON.parse(savedData);
                        // Sync localStorage data to Firebase
                        await syncSurveyDataToFirebase(surveyData);
                        console.log('📤 Local survey data synced to Firebase');
                    }
                }
                
                // Load budget data from Firebase
                const firebaseBudgetData = await loadBudgetDataFromFirebase();
                if (firebaseBudgetData) {
                    Object.assign(projectBudgets, firebaseBudgetData);
                    localStorage.setItem('projectBudgets', JSON.stringify(projectBudgets));
                    console.log('✅ Budget data loaded from Firebase');
                } else {
                    // Fallback to localStorage
                    const savedBudgets = localStorage.getItem('projectBudgets');
                    if (savedBudgets) {
                        const loadedBudgets = JSON.parse(savedBudgets);
                        // Merge with default budgets to ensure all projects exist
                        Object.keys(projectBudgets).forEach(key => {
                            if (loadedBudgets[key]) {
                                projectBudgets[key] = loadedBudgets[key];
                            }
                        });
                    }
                    // Sync localStorage budget data to Firebase
                    await syncBudgetDataToFirebase(projectBudgets);
                    console.log('📤 Local budget data synced to Firebase');
                }
                
                updateFirebaseStatus('connected', 'เชื่อมต่อกับ Firebase สำเร็จ - ข้อมูลซิงค์แบบ Real-time');
                
                // Hide status after 3 seconds of successful connection
                setTimeout(() => {
                    hideFirebaseStatus();
                }, 3000);
                
            } catch (error) {
                console.error('❌ Error loading from Firebase, using localStorage:', error);
                updateFirebaseStatus('error', 'ไม่สามารถเชื่อมต่อ Firebase ได้ - ใช้ข้อมูลในเครื่อง');
                
                // Fallback to localStorage only
                const savedData = localStorage.getItem('surveyData');
                if (savedData) {
                    surveyData = JSON.parse(savedData);
                }
                
                const savedBudgets = localStorage.getItem('projectBudgets');
                if (savedBudgets) {
                    const loadedBudgets = JSON.parse(savedBudgets);
                    Object.keys(projectBudgets).forEach(key => {
                        if (loadedBudgets[key]) {
                            projectBudgets[key] = loadedBudgets[key];
                        }
                    });
                }
                
                // Hide error status after 5 seconds
                setTimeout(() => {
                    hideFirebaseStatus();
                }, 5000);
            }
            
            // Update budget display
            updateBudgetDisplay();
            console.log('🎉 Application initialized with Firebase sync');
        });

        // Procurement Tracking Functions
        let trackingData = [];
        let currentTrackingFilter = 'all';
        let trackingStatusChart = null;
        let departmentStatusChart = null;

        // Load tracking data from surveys
        function loadTrackingData() {
            console.log('loadTrackingData called, surveyData length:', surveyData.length);
            trackingData = surveyData.map(survey => ({
                id: survey.id,
                requester: survey.fullName,
                department: survey.department,
                projectSelection: survey.projectSelection,
                procurementType: survey.procurementType,
                procurementItem: survey.procurementItem,
                totalBudget: survey.totalBudget,
                urgency: survey.urgency,
                items: survey.items,
                trackingStatus: survey.trackingStatus || 'pending_budget_approval',
                lastUpdated: survey.lastUpdated || survey.submitDate,
                notes: survey.trackingNotes || '',
                submitDate: survey.submitDate
            }));
            console.log('trackingData after mapping:', trackingData.length);
            updateTrackingDisplay();
            updateTrackingSummary();
        }

        // Update tracking status for a specific survey
        function updateTrackingStatus(surveyId, newStatus, notes = '') {
            const surveyIndex = surveyData.findIndex(survey => survey.id == surveyId);
            if (surveyIndex !== -1) {
                surveyData[surveyIndex].trackingStatus = newStatus;
                surveyData[surveyIndex].lastUpdated = new Date().toISOString();
                surveyData[surveyIndex].trackingNotes = notes;
                
                // Save to localStorage
                localStorage.setItem('surveyData', JSON.stringify(surveyData));
                
                // Sync to Firebase
                syncSurveyDataToFirebase(surveyData).then(() => {
                    console.log('✅ Survey data synced to Firebase after status update');
                }).catch((error) => {
                    console.error('❌ Failed to sync survey data to Firebase:', error);
                });
                
                // Reload tracking data to update charts
                loadTrackingData();
                
                return true;
            }
            return false;
        }

        // Filter tracking data by status
        function filterByStatus(status) {
            currentTrackingFilter = status;
            updateTrackingDisplay();
        }

        // Update tracking display table
        function updateTrackingDisplay() {
            // Use filtered display function with all data initially
            displayFilteredTrackingData(trackingData);
            updateTrackingFilterResults(trackingData.length, trackingData.length);
            
            // Populate filter dropdowns
            populateTrackingFilters();
        }        // Get status information for display
        function getStatusInfo(status) {
            const statusMap = {
                'pending_budget_approval': { 
                    text: 'รออนุมัติงบประมาณ', 
                    class: 'bg-yellow-100 text-yellow-800', 
                    bgColor: 'bg-yellow-50', 
                    textColor: 'text-yellow-700',
                    color: '#F59E0B',
                    icon: '⏳'
                },
                'budget_approved': {
                    text: 'อนุมัติงบประมาณแล้ว', 
                    class: 'bg-green-100 text-green-800', 
                    bgColor: 'bg-green-50', 
                    textColor: 'text-green-700',
                    color: '#10B981',
                    icon: '✅'
                },
                'in_procurement': {
                    text: 'อยู่ระหว่างจัดซื้อ', 
                    class: 'bg-blue-100 text-blue-800', 
                    bgColor: 'bg-blue-50', 
                    textColor: 'text-blue-700',
                    color: '#3B82F6',
                    icon: '🔄'
                },
                'completed': {
                    text: 'เสร็จสิ้น', 
                    class: 'bg-purple-100 text-purple-800', 
                    bgColor: 'bg-purple-50', 
                    textColor: 'text-purple-700',
                    color: '#8B5CF6',
                    icon: '🎉'
                },
                'cancelled': {
                    text: 'ยกเลิก', 
                    class: 'bg-red-100 text-red-800', 
                    bgColor: 'bg-red-50', 
                    textColor: 'text-red-700',
                    color: '#EF4444',
                    icon: '❌'
                }
            };
            return statusMap[status] || statusMap['pending_budget_approval'];
        }

        // Get urgency badge for display
        function getUrgencyBadge(urgency) {
            const urgencyMap = {
                'เร่งด่วนมาก': {
                    text: 'เร่งด่วนมาก',
                    class: 'bg-red-100 text-red-800 border border-red-200',
                    icon: '🔥'
                },
                'เร่งด่วน': {
                    text: 'เร่งด่วน',
                    class: 'bg-orange-100 text-orange-800 border border-orange-200',
                    icon: '⚡'
                },
                'ปานกลาง': {
                    text: 'ปานกลาง',
                    class: 'bg-blue-100 text-blue-800 border border-blue-200',
                    icon: '🟦'
                },
                'ไม่เร่งด่วน': {
                    text: 'ไม่เร่งด่วน',
                    class: 'bg-gray-100 text-gray-800 border border-gray-200',
                    icon: '🟨'
                }
            };
            
            const info = urgencyMap[urgency] || urgencyMap['ปานกลาง'];
            
            return `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${info.class}">
                    ${info.icon} ${info.text}
                </span>
            `;
        }

        // Update tracking summary cards
        function updateTrackingSummary() {
            // Update tracking status chart
            updateTrackingStatusChart();
            updateDepartmentStatusChart();
        }

        // Refresh tracking data
        function refreshTrackingData() {
            loadTrackingData();
            populateTrackingFilters();
            alert('🔄 ข้อมูลการติดตามได้รับการอัปเดตแล้ว');
        }

        // Populate filter dropdowns with unique values from data
        function populateTrackingFilters() {
            // Get unique projects
            const projects = [...new Set(trackingData.map(item => item.projectSelection).filter(Boolean))].sort();
            const projectSelect = document.getElementById('filterTrackingProject');
            projectSelect.innerHTML = '<option value="">ทุกโครงการ</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSelect.appendChild(option);
            });

            // Get unique departments
            const departments = [...new Set(trackingData.map(item => item.department).filter(Boolean))].sort();
            const departmentSelect = document.getElementById('filterTrackingDepartment');
            departmentSelect.innerHTML = '<option value="">ทุกหน่วยงาน</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
        }

        // Filter tracking data based on selected criteria
        function filterTrackingData() {
            const projectFilter = document.getElementById('filterTrackingProject').value;
            const departmentFilter = document.getElementById('filterTrackingDepartment').value;
            const typeFilter = document.getElementById('filterTrackingType').value;
            const itemsFilter = document.getElementById('filterTrackingItems').value.toLowerCase();

            let filteredData = trackingData.filter(item => {
                // Project filter
                const projectMatch = !projectFilter || item.projectSelection === projectFilter;
                
                // Department filter
                const departmentMatch = !departmentFilter || item.department === departmentFilter;
                
                // Type filter
                const typeMatch = !typeFilter || item.procurementType === typeFilter;
                
                // Items filter - search in item descriptions
                const itemsMatch = !itemsFilter || (item.items && item.items.some(itemObj => 
                    itemObj.description.toLowerCase().includes(itemsFilter) ||
                    itemObj.note.toLowerCase().includes(itemsFilter)
                )) || (item.procurementItem && item.procurementItem.toLowerCase().includes(itemsFilter));

                return projectMatch && departmentMatch && typeMatch && itemsMatch;
            });

            // Update display with filtered data
            displayFilteredTrackingData(filteredData);
            updateTrackingFilterResults(filteredData.length, trackingData.length);
        }

        // Display filtered tracking data
        function displayFilteredTrackingData(filteredData) {
            const tableBody = document.getElementById('trackingTableBody');
            const noDataDiv = document.getElementById('noTrackingData');
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '';
                noDataDiv.classList.remove('hidden');
                noDataDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">🔍</div>
                        <p class="text-lg font-medium">ไม่พบข้อมูลที่ตรงกับเงื่อนไขการค้นหา</p>
                        <p class="text-sm">กรุณาปรับเงื่อนไขการกรองหรือล้างตัวกรองเพื่อดูข้อมูลทั้งหมด</p>
                    </div>
                `;
                return;
            }
            
            noDataDiv.classList.add('hidden');
            
            tableBody.innerHTML = filteredData.map((item, index) => {
                const statusInfo = getStatusInfo(item.trackingStatus);
                const urgencyBadge = getUrgencyBadge(item.urgency);
                const lastUpdated = item.lastUpdated ? new Date(item.lastUpdated).toLocaleDateString('th-TH') : 'ไม่ระบุ';
                
                // Find original index for edit/delete functions
                const originalIndex = trackingData.findIndex(original => original.id === item.id);
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 text-center text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-4 py-3 text-center">${urgencyBadge}</td>
                        <td class="px-2 py-3 text-xs text-gray-700">
                            <div class="max-w-48 break-words">${item.projectSelection || 'ไม่ระบุ'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${item.requester}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${item.procurementType}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <div class="max-w-32 break-words">${item.procurementItem || 'ไม่ระบุ'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900 text-right">${(item.totalBudget || 0).toLocaleString('th-TH')} บาท</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${lastUpdated}</td>
                        <td class="px-4 py-3 text-center">
                            <select class="text-xs px-2 py-1 rounded border border-gray-300 ${statusInfo.bgColor} ${statusInfo.textColor} cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    onchange="requestStatusUpdatePassword(${item.id}, this.value)" 
                                    value="${item.trackingStatus}">
                                <option value="pending_budget_approval" ${item.trackingStatus === 'pending_budget_approval' ? 'selected' : ''}>รออนุมัติงบประมาณ</option>
                                <option value="budget_approved" ${item.trackingStatus === 'budget_approved' ? 'selected' : ''}>อนุมัติงบประมาณแล้ว</option>
                                <option value="in_procurement" ${item.trackingStatus === 'in_procurement' ? 'selected' : ''}>อยู่ระหว่างจัดซื้อ</option>
                                <option value="completed" ${item.trackingStatus === 'completed' ? 'selected' : ''}>เสร็จสิ้น</option>
                                <option value="cancelled" ${item.trackingStatus === 'cancelled' ? 'selected' : ''}>ยกเลิก</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center space-x-1">
                                <button onclick="viewDetails(${originalIndex})" class="status-button bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded" title="ดูรายละเอียด">
                                    🖨️
                                </button>
                                <button onclick="requestTrackingEditPassword(${originalIndex})" class="status-button bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-2 py-1 rounded" title="แก้ไข">
                                    ✏️
                                </button>
                                <button onclick="requestTrackingDeletePassword(${originalIndex})" class="status-button bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded" title="ลบ">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Clear all tracking filters
        function clearTrackingFilters() {
            document.getElementById('filterTrackingProject').value = '';
            document.getElementById('filterTrackingDepartment').value = '';
            document.getElementById('filterTrackingType').value = '';
            document.getElementById('filterTrackingItems').value = '';
            
            // Show all data
            displayFilteredTrackingData(trackingData);
            updateTrackingFilterResults(trackingData.length, trackingData.length);
        }

        // Update filter results display
        function updateTrackingFilterResults(shown, total) {
            const filterResults = document.getElementById('trackingFilterResults');
            if (total === 0) {
                filterResults.innerHTML = '';
            } else {
                filterResults.innerHTML = `แสดง ${shown} จาก ${total} รายการ`;
            }
        }

        // Print tracking report with current filters
        function printTrackingReport() {
            // Get currently filtered data
            const projectFilter = document.getElementById('filterTrackingProject').value;
            const departmentFilter = document.getElementById('filterTrackingDepartment').value;
            const typeFilter = document.getElementById('filterTrackingType').value;
            const itemsFilter = document.getElementById('filterTrackingItems').value.toLowerCase();

            let filteredData = trackingData.filter(item => {
                const projectMatch = !projectFilter || item.projectSelection === projectFilter;
                const departmentMatch = !departmentFilter || item.department === departmentFilter;
                const typeMatch = !typeFilter || item.procurementType === typeFilter;
                const itemsMatch = !itemsFilter || (item.items && item.items.some(itemObj => 
                    itemObj.description.toLowerCase().includes(itemsFilter) ||
                    itemObj.note.toLowerCase().includes(itemsFilter)
                )) || (item.procurementItem && item.procurementItem.toLowerCase().includes(itemsFilter));

                return projectMatch && departmentMatch && typeMatch && itemsMatch;
            });

            if (filteredData.length === 0) {
                alert('❌ ไม่มีข้อมูลสำหรับพิมพ์รายงาน\nกรุณาปรับเงื่อนไขการกรองหรือเพิ่มข้อมูล');
                return;
            }

            // Calculate summary data
            const totalBudget = filteredData.reduce((sum, item) => sum + (item.totalBudget || 0), 0);
            const departments = [...new Set(filteredData.map(item => item.department))].sort();
            const projects = [...new Set(filteredData.map(item => item.projectSelection))].sort();
            const statusCounts = {};
            const departmentBudgets = {};
            
            filteredData.forEach(item => {
                const status = item.trackingStatus || 'pending_budget_approval';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                
                const dept = item.department;
                departmentBudgets[dept] = (departmentBudgets[dept] || 0) + (item.totalBudget || 0);
            });

            // Get filter info
            const filterInfo = [];
            if (projectFilter) filterInfo.push(`โครงการ: ${projectFilter}`);
            if (departmentFilter) filterInfo.push(`หน่วยงาน: ${departmentFilter}`);
            if (typeFilter) filterInfo.push(`ประเภท: ${typeFilter}`);
            if (itemsFilter) filterInfo.push(`รายการ: ${itemsFilter}`);
            const filterText = filterInfo.length > 0 ? filterInfo.join(', ') : 'ทั้งหมด';

            // Create print content
            const printContent = `
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>รายงานการติดตามการดำเนินการจัดซื้อจัดจ้าง</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
                        
                        body {
                            font-family: 'Sarabun', sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: white;
                            color: #333;
                            line-height: 1.6;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #3B82F6;
                            padding-bottom: 20px;
                        }
                        
                        .header h1 {
                            color: #1F2937;
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                        }
                        
                        .header h2 {
                            color: #6B7280;
                            margin: 5px 0;
                            font-size: 18px;
                            font-weight: 500;
                        }
                        
                        .summary-section {
                            background: #F8FAFC;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 30px;
                            border: 1px solid #E2E8F0;
                        }
                        
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin-bottom: 20px;
                        }
                        
                        .summary-item {
                            background: white;
                            padding: 15px;
                            border-radius: 6px;
                            border: 1px solid #E5E7EB;
                            text-align: center;
                        }
                        
                        .summary-item .label {
                            font-size: 14px;
                            color: #6B7280;
                            margin-bottom: 5px;
                        }
                        
                        .summary-item .value {
                            font-size: 18px;
                            font-weight: 600;
                            color: #1F2937;
                        }
                        
                        .charts-section {
                            margin-bottom: 30px;
                        }
                        
                        .chart-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 30px;
                            margin-bottom: 20px;
                        }
                        
                        .chart-item {
                            background: #F8FAFC;
                            padding: 20px;
                            border-radius: 8px;
                            border: 1px solid #E2E8F0;
                        }
                        
                        .chart-title {
                            font-size: 16px;
                            font-weight: 600;
                            color: #1F2937;
                            margin-bottom: 15px;
                            text-align: center;
                        }
                        
                        .legend-item {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 4px;
                            margin-bottom: 5px;
                            border: 1px solid #E5E7EB;
                        }
                        
                        .legend-color {
                            width: 16px;
                            height: 16px;
                            border-radius: 4px;
                            margin-right: 8px;
                        }
                        
                        .legend-label {
                            flex: 1;
                            font-size: 14px;
                        }
                        
                        .legend-value {
                            font-weight: 600;
                            font-size: 14px;
                        }
                        
                        .table-section {
                            margin-bottom: 30px;
                        }
                        
                        .section-title {
                            font-size: 18px;
                            font-weight: 600;
                            color: #1F2937;
                            margin-bottom: 15px;
                            border-bottom: 2px solid #E5E7EB;
                            padding-bottom: 8px;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            background: white;
                            border: 1px solid #E5E7EB;
                            border-radius: 6px;
                            overflow: hidden;
                        }
                        
                        th {
                            background: #F3F4F6;
                            padding: 12px 8px;
                            text-align: center;
                            font-weight: 600;
                            font-size: 13px;
                            border-bottom: 1px solid #E5E7EB;
                            color: #374151;
                        }
                        
                        td {
                            padding: 10px 8px;
                            border-bottom: 1px solid #F3F4F6;
                            font-size: 12px;
                            text-align: center;
                        }
                        
                        tr:nth-child(even) {
                            background: #FAFAFA;
                        }
                        
                        .status-badge {
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 11px;
                            font-weight: 500;
                            white-space: nowrap;
                        }
                        
                        .status-pending { background: #FEF3C7; color: #92400E; }
                        .status-approved { background: #D1FAE5; color: #065F46; }
                        .status-procurement { background: #DBEAFE; color: #1E40AF; }
                        .status-completed { background: #E0E7FF; color: #5B21B6; }
                        .status-cancelled { background: #FEE2E2; color: #991B1B; }
                        
                        .urgency-badge {
                            padding: 3px 6px;
                            border-radius: 10px;
                            font-size: 10px;
                            font-weight: 500;
                            white-space: nowrap;
                        }
                        
                        .urgency-high { background: #FEE2E2; color: #991B1B; }
                        .urgency-medium { background: #FED7AA; color: #9A3412; }
                        .urgency-normal { background: #DBEAFE; color: #1E40AF; }
                        .urgency-low { background: #F3F4F6; color: #374151; }
                        
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 12px;
                            color: #6B7280;
                            border-top: 1px solid #E5E7EB;
                            padding-top: 15px;
                        }
                        
                        @media print {
                            body { margin: 0; padding: 15px; }
                            .chart-grid { grid-template-columns: 1fr; }
                            .summary-grid { grid-template-columns: repeat(4, 1fr); }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>📊 รายงานการติดตามการดำเนินการจัดซื้อจัดจ้าง</h1>
                        <h2>คณะมนุษยศาสตร์และสังคมศาสตร์ มหาวิทยาลัยราชภัฏสุราษฎร์ธานี</h2>
                        <p style="margin: 10px 0; color: #6B7280;">วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                        <p style="margin: 5px 0; color: #374151; font-weight: 500;">เงื่อนไขการกรอง: ${filterText}</p>
                    </div>

                    <div class="summary-section">
                        <h3 class="section-title">📈 สรุปภาพรวม</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="label">จำนวนรายการทั้งหมด</div>
                                <div class="value">${filteredData.length} รายการ</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">งบประมาณรวม</div>
                                <div class="value">${totalBudget.toLocaleString('th-TH')} บาท</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">จำนวนหน่วยงาน</div>
                                <div class="value">${departments.length} หน่วยงาน</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">จำนวนโครงการ</div>
                                <div class="value">${projects.length} โครงการ</div>
                            </div>
                        </div>
                    </div>

                    <div class="charts-section">
                        <h3 class="section-title">📊 กราฟสรุปข้อมูล</h3>
                        <div class="chart-grid">
                            <div class="chart-item">
                                <div class="chart-title">📋 สถานะการดำเนินการ</div>
                                ${Object.keys(statusCounts).map(status => {
                                    const statusInfo = getStatusInfo(status);
                                    const count = statusCounts[status] || 0;
                                    const percentage = filteredData.length > 0 ? ((count / filteredData.length) * 100).toFixed(1) : 0;
                                    return `
                                        <div class="legend-item">
                                            <div style="display: flex; align-items: center;">
                                                <div class="legend-color" style="background: ${statusInfo.color};"></div>
                                                <span class="legend-label">${statusInfo.text}</span>
                                            </div>
                                            <span class="legend-value">${count} รายการ (${percentage}%)</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div class="chart-item">
                                <div class="chart-title">🏢 งบประมาณตามหน่วยงาน</div>
                                ${Object.keys(departmentBudgets).map(dept => {
                                    const budget = departmentBudgets[dept];
                                    const percentage = totalBudget > 0 ? ((budget / totalBudget) * 100).toFixed(1) : 0;
                                    const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#F97316'];
                                    const colorIndex = Object.keys(departmentBudgets).indexOf(dept) % colors.length;
                                    return `
                                        <div class="legend-item">
                                            <div style="display: flex; align-items: center;">
                                                <div class="legend-color" style="background: ${colors[colorIndex]};"></div>
                                                <span class="legend-label">${dept}</span>
                                            </div>
                                            <span class="legend-value">${budget.toLocaleString('th-TH')} บาท (${percentage}%)</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="table-section">
                        <h3 class="section-title">📋 รายละเอียดการติดตาม</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;">ลำดับ</th>
                                    <th style="width: 80px;">ความเร่งด่วน</th>
                                    <th style="width: 150px;">โครงการ</th>
                                    <th style="width: 100px;">ผู้ขอ</th>
                                    <th style="width: 120px;">หน่วยงาน</th>
                                    <th style="width: 80px;">ประเภท</th>
                                    <th style="width: 120px;">พัสดุ</th>
                                    <th style="width: 100px;">งบประมาณ</th>
                                    <th style="width: 80px;">วันที่อัปเดต</th>
                                    <th style="width: 100px;">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredData.map((item, index) => {
                                    const statusInfo = getStatusInfo(item.trackingStatus);
                                    const lastUpdated = item.lastUpdated ? new Date(item.lastUpdated).toLocaleDateString('th-TH') : '-';
                                    
                                    const urgencyClass = {
                                        'เร่งด่วนมาก': 'urgency-high',
                                        'เร่งด่วน': 'urgency-medium', 
                                        'ปานกลาง': 'urgency-normal',
                                        'ไม่เร่งด่วน': 'urgency-low'
                                    }[item.urgency] || 'urgency-normal';
                                    
                                    const statusClass = {
                                        'pending_budget_approval': 'status-pending',
                                        'budget_approved': 'status-approved',
                                        'in_procurement': 'status-procurement', 
                                        'completed': 'status-completed',
                                        'cancelled': 'status-cancelled'
                                    }[item.trackingStatus] || 'status-pending';
                                    
                                    return `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td><span class="urgency-badge ${urgencyClass}">${item.urgency || 'ปานกลาง'}</span></td>
                                            <td style="text-align: left; font-size: 11px;">${(item.projectSelection || '').substring(0, 50)}${(item.projectSelection || '').length > 50 ? '...' : ''}</td>
                                            <td>${item.requester || '-'}</td>
                                            <td>${item.department || '-'}</td>
                                            <td>${item.procurementType || '-'}</td>
                                            <td style="text-align: left; font-size: 11px;">${(item.procurementItem || '').substring(0, 30)}${(item.procurementItem || '').length > 30 ? '...' : ''}</td>
                                            <td style="text-align: right;">${(item.totalBudget || 0).toLocaleString('th-TH')} บาท</td>
                                            <td>${lastUpdated}</td>
                                            <td><span class="status-badge ${statusClass}">${statusInfo.text}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="footer">
                        <p>รายงานนี้สร้างโดยระบบสำรวจความต้องการพัสดุ คณะมนุษยศาสตร์และสังคมศาสตร์</p>
                        <p>พิมพ์เมื่อ: ${new Date().toLocaleString('th-TH')}</p>
                    </div>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 1000);
        }

        // Update tracking status chart
        function updateTrackingStatusChart() {
            console.log('updateTrackingStatusChart called, trackingData length:', trackingData.length);
            
            if (trackingData.length === 0) {
                // Hide chart if no data
                if (trackingStatusChart) {
                    trackingStatusChart.destroy();
                    trackingStatusChart = null;
                }
                const legendElement = document.getElementById('trackingStatusLegend');
                const itemsElement = document.getElementById('totalTrackingItems');
                const budgetElement = document.getElementById('totalTrackingBudget');
                
                if (legendElement) legendElement.innerHTML = '<p class="text-gray-500 text-center">ไม่มีข้อมูลสำหรับแสดงกราฟ</p>';
                if (itemsElement) itemsElement.textContent = '0 รายการ';
                if (budgetElement) budgetElement.textContent = '0 บาท';
                return;
            }

            // Calculate status distribution
            const statusCounts = {
                'pending_budget_approval': 0,
                'budget_approved': 0,
                'in_procurement': 0,
                'completed': 0,
                'cancelled': 0
            };
            
            let totalBudget = 0;
            
            trackingData.forEach(item => {
                const status = item.trackingStatus || 'pending_budget_approval';
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }
                totalBudget += item.totalBudget || 0;
            });

            const labels = [];
            const data = [];
            const colors = [];
            const statusInfo = {
                'pending_budget_approval': { label: 'รออนุมัติงบประมาณ', color: '#F59E0B'},
                'budget_approved': { label: 'อนุมัติงบประมาณแล้ว', color: '#10B981'},
                'in_procurement': { label: 'อยู่ระหว่างจัดซื้อ', color: '#3B82F6'},
                'completed': { label: 'เสร็จสิ้น', color: '#8B5CF6'},
                'cancelled': { label: 'ยกเลิก', color: '#EF4444'}
            };

            // Prepare data for chart - แสดงทุกสถานะรวมถึงที่มีค่า 0
            Object.keys(statusCounts).forEach(status => {
                labels.push(statusInfo[status].label);
                data.push(statusCounts[status]);
                colors.push(statusInfo[status].color);
            });

            // ตรวจสอบว่ามีข้อมูลหรือไม่ (แม้ทุกค่าจะเป็น 0)
            const hasAnyData = data.some(value => value > 0);
            
            if (!hasAnyData) {
                // ถ้าทุกสถานะเป็น 0 ให้แสดงข้อความแจ้งเตือน
                if (trackingStatusChart) {
                    trackingStatusChart.destroy();
                    trackingStatusChart = null;
                }
                const legendElement = document.getElementById('trackingStatusLegend');
                if (legendElement) legendElement.innerHTML = '<p class="text-gray-500 text-center">ไม่มีข้อมูลสำหรับแสดงกราฟ</p>';
                return;
            }

            const canvasElement = document.getElementById('trackingStatusChart');
            if (!canvasElement) {
                console.error('Canvas element trackingStatusChart not found');
                return;
            }
            
            const ctx = canvasElement.getContext('2d');
            
            if (trackingStatusChart) {
                trackingStatusChart.destroy();
            }

            trackingStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${label}: ${value} รายการ (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });

            // Create custom legend - แสดงทุกสถานะรวมถึงที่มีค่า 0
            let legendHtml = '';
            const total = data.reduce((a, b) => a + b, 0);
            
            Object.keys(statusCounts).forEach(status => {
                const count = statusCounts[status];
                const info = statusInfo[status];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                legendHtml += `
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-gray-100 hover:shadow-sm transition-shadow">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2 flex-shrink-0" style="background-color: ${info.color}"></div>
                            <div class="min-w-0">
                                <div class="text-xs font-medium text-gray-800 truncate">${info.label}</div>
                                <div class="text-xs text-gray-500">${percentage}% ของทั้งหมด</div>
                            </div>
                        </div>
                        <div class="text-sm font-bold text-gray-900 ml-2">${count}</div>
                    </div>
                `;
            });
            
            const legendElement = document.getElementById('trackingStatusLegend');
            const itemsElement = document.getElementById('totalTrackingItems');
            const budgetElement = document.getElementById('totalTrackingBudget');
            
            if (legendElement) legendElement.innerHTML = legendHtml;
            if (itemsElement) itemsElement.textContent = `${total} รายการ`;
            if (budgetElement) budgetElement.textContent = `${totalBudget.toLocaleString('th-TH')} บาท`;
        }

        // Department status chart function
        function updateDepartmentStatusChart() {
            console.log('updateDepartmentStatusChart called, trackingData length:', trackingData.length);
            
            if (trackingData.length === 0) {
                // Hide chart if no data
                if (departmentStatusChart) {
                    departmentStatusChart.destroy();
                    departmentStatusChart = null;
                }
                const legendElement = document.getElementById('departmentStatusLegend');
                const deptElement = document.getElementById('totalDepartments');
                const budgetElement = document.getElementById('totalDepartmentBudget');
                
                if (legendElement) legendElement.innerHTML = '<p class="text-gray-500 text-center">ไม่มีข้อมูลสำหรับแสดงกราฟ</p>';
                if (deptElement) deptElement.textContent = '0 ฝ่าย';
                if (budgetElement) budgetElement.textContent = '0 บาท';
                return;
            }

            // Calculate department distribution
            const departmentCounts = {};
            const departmentBudgets = {};
            
            let totalBudget = 0;
            
            trackingData.forEach(item => {
                const department = item.department || 'ไม่ระบุฝ่าย';
                departmentCounts[department] = (departmentCounts[department] || 0) + 1;
                departmentBudgets[department] = (departmentBudgets[department] || 0) + (item.totalBudget || 0);
                totalBudget += item.totalBudget || 0;
            });

            const labels = Object.keys(departmentCounts);
            const data = Object.values(departmentCounts);
            const colors = [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', 
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280',
                '#14B8A6', '#F472B6', '#A855F7', '#22D3EE', '#FCD34D'
            ];

            // Limit colors to data length, cycling if needed
            const chartColors = data.map((_, index) => colors[index % colors.length]);

            const canvasElement = document.getElementById('departmentStatusChart');
            if (!canvasElement) {
                console.error('Canvas element departmentStatusChart not found');
                return;
            }
            
            const ctx = canvasElement.getContext('2d');
            
            if (departmentStatusChart) {
                departmentStatusChart.destroy();
            }

            departmentStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: chartColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                    const budget = departmentBudgets[label] || 0;
                                    return `${label}: ${value} รายการ (${percentage}%) - ${budget.toLocaleString('th-TH')} บาท`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });

            // Create custom legend
            let legendHtml = '';
            const total = data.reduce((a, b) => a + b, 0);
            
            labels.forEach((department, index) => {
                const count = departmentCounts[department];
                const budget = departmentBudgets[department];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                const color = chartColors[index];
                
                legendHtml += `
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-gray-100 hover:shadow-sm transition-shadow">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2 flex-shrink-0" style="background-color: ${color}"></div>
                            <div class="min-w-0">
                                <div class="text-xs font-medium text-gray-800 truncate">${department}</div>
                                <div class="text-xs text-gray-500">${percentage}% - ${budget.toLocaleString('th-TH')} บาท</div>
                            </div>
                        </div>
                        <div class="text-sm font-bold text-gray-900 ml-2">${count}</div>
                    </div>
                `;
            });
            
            const legendElement = document.getElementById('departmentStatusLegend');
            const deptElement = document.getElementById('totalDepartments');
            const budgetElement = document.getElementById('totalDepartmentBudget');
            
            if (legendElement) legendElement.innerHTML = legendHtml;
            if (deptElement) deptElement.textContent = `${labels.length} ฝ่าย`;
            if (budgetElement) budgetElement.textContent = `${totalBudget.toLocaleString('th-TH')} บาท`;
        }

        // Password protection functions for tracking management
        function requestTrackingEditPassword(index) {
            const password = prompt('🔒 กรุณากรอกรหัสผ่านเพื่อแก้ไขแบบสำรวจ:', '');
            
            if (password === null) {
                return; // User canceled
            }
            
            if (password === '01234') {
                editSurvey(index);
            } else {
                alert('❌ รหัสผ่านไม่ถูกต้อง!\n🚫 ไม่สามารถแก้ไขข้อมูลได้\n📞 กรุณาติดต่อผู้ดูแลระบบหากต้องการแก้ไขข้อมูล');
            }
        }

        function requestTrackingDeletePassword(index) {
            const data = surveyData[index];
            const password = prompt('🔒 กรุณากรอกรหัสผ่านเพื่อลบแบบสำรวจ:', '');
            
            if (password === null) {
                return; // User canceled
            }
            
            if (password === '01234') {
                const confirmation = confirm(
                    `⚠️ ยืนยันการลบข้อมูล\n\n` +
                    `👤 ผู้ส่ง: ${data.fullName || '-'}\n` +
                    `🏢 หน่วยงาน: ${data.department || '-'}\n` +
                    `💰 งบประมาณ: ${data.totalBudget.toLocaleString('th-TH')} บาท\n\n` +
                    `❗ การลบข้อมูลไม่สามารถยกเลิกได้ คุณต้องการดำเนินการต่อหรือไม่?`
                );
                
                if (confirmation) {
                    deleteSurveyRecord(index);
                }
            } else {
                alert('❌ รหัสผ่านไม่ถูกต้อง!\n🚫 ไม่สามารถลบข้อมูลได้\n📞 กรุณาติดต่อผู้ดูแลระบบหากต้องการลบข้อมูล');
            }
        }

        function requestStatusUpdatePassword(surveyId, newStatus) {
            // Get current status to revert if password is wrong
            const currentSurvey = surveyData.find(s => s.id == surveyId);
            const currentStatus = currentSurvey ? (currentSurvey.trackingStatus || 'pending_budget_approval') : 'pending_budget_approval';
            
            // Find the dropdown element that triggered this change
            const dropdown = event.target;
            
            const password = prompt('🔒 กรุณากรอกรหัสผ่านเพื่อปรับสถานะการดำเนินการ:', '');
            
            if (password === null) {
                // User canceled - revert dropdown
                dropdown.value = currentStatus;
                return;
            }
            
            if (password === '01234') {
                // Password correct - update status
                const success = updateTrackingStatus(surveyId, newStatus);
                
                if (success) {
                    // Update dropdown styling to match new status
                    const statusInfo = getStatusInfo(newStatus);
                    dropdown.className = `text-xs px-2 py-1 rounded border border-gray-300 ${statusInfo.bgColor} ${statusInfo.textColor} cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500`;
                    
                    alert(`✅ อัปเดตสถานะเรียบร้อยแล้ว!\n\n🔄 สถานะใหม่: ${statusInfo.text}`);
                } else {
                    // Failed to update - revert dropdown
                    dropdown.value = currentStatus;
                    alert('❌ ไม่สามารถอัปเดตสถานะได้ กรุณาลองใหม่');
                }
            } else {
                // Password wrong - revert dropdown
                dropdown.value = currentStatus;
                alert('❌ รหัสผ่านไม่ถูกต้อง!\n🚫 ไม่สามารถปรับสถานะได้\n📞 กรุณาติดต่อผู้ดูแลระบบหากต้องการปรับสถานะ');
            }
        }

        // View record details
        function viewDetails(index) {
            const record = surveyData[index];
            if (!record) {
                alert('❌ ไม่พบข้อมูลที่ต้องการดู');
                return;
            }

            // Create detailed view modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // สร้างตารางรายการพัสดุ
            let itemsTable = '';
            if (record.items && record.items.length > 0) {
                itemsTable = `
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">รายการที่ต้องการจัดซื้อ/จัดจ้าง</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border border-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium">ลำดับ</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium">รายการ</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium">รายละเอียดวัสดุ/งานจ้าง</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium">วัตถุประสงค์</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium">จำนวน</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium">หน่วยนับ</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium">งบประมาณ/รายการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${record.items.map((item, i) => `
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-2 text-center text-sm">${i + 1}</td>
                                            <td class="border border-gray-300 px-2 py-2 text-sm">${item.description || '-'}</td>
                                            <td class="border border-gray-300 px-2 py-2 text-sm">${item.note || '-'}</td>
                                            <td class="border border-gray-300 px-2 py-2 text-sm">${item.purpose || '-'}</td>
                                            <td class="border border-gray-300 px-2 py-2 text-center text-sm">${item.quantity || '0'}</td>
                                            <td class="border border-gray-300 px-2 py-2 text-center text-sm">${item.unit || '-'}</td>
                                            <td class="border border-gray-300 px-2 py-2 text-right text-sm">${item.total ? item.total.toLocaleString('th-TH') : '0'} บาท</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot class="bg-gray-50">
                                    <tr>
                                        <td colspan="6" class="border border-gray-300 px-2 py-2 text-right text-sm font-semibold">งบประมาณรวม:</td>
                                        <td class="border border-gray-300 px-2 py-2 text-right text-sm font-bold text-green-600">${record.totalBudget ? parseInt(record.totalBudget).toLocaleString('th-TH') : '0'} บาท</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-6xl w-full m-4 max-h-screen overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">📋 รายละเอียดแบบสำรวจการจัดซื้อจัดจ้าง</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- ข้อมูลผู้ตอบแบบสำรวจ -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">👤 ข้อมูลผู้ตอบแบบสำรวจ</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล</label>
                                    <p class="mt-1 text-sm text-gray-900 font-medium">${record.fullName || '-'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">หน่วยงาน/ฝ่าย</label>
                                    <p class="mt-1 text-sm text-gray-900 font-medium">${record.department || '-'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ข้อมูลโครงการและการจัดหา -->
                        <div class="bg-green-50 rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">🎯 ข้อมูลโครงการและการจัดหา</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">โครงการ</label>
                                    <p class="mt-1 text-sm text-gray-900 font-medium">${record.projectSelection || '-'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ประเภทการจัดหา</label>
                                    <p class="mt-1 text-sm text-gray-900 font-medium">${record.procurementType || '-'}</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">พัสดุที่จัดหา</label>
                                    <p class="mt-1 text-sm text-gray-900 font-medium">${record.procurementItem || '-'}</p>
                                </div>
                            </div>
                        </div>

                        ${itemsTable}
                        
                        <!-- ข้อมูลเพิ่มเติม -->
                        <div class="bg-yellow-50 rounded-lg p-4 mt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">📄 ข้อมูลเพิ่มเติม</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">วันที่ส่งแบบสำรวจ</label>
                                    <p class="mt-1 text-sm text-gray-900 font-medium">${record.submitDate ? new Date(record.submitDate).toLocaleDateString('th-TH') : '-'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">วันที่อัปเดตล่าสุด</label>
                                    <p class="mt-1 text-sm text-gray-900 font-medium">${record.lastUpdated ? new Date(record.lastUpdated).toLocaleDateString('th-TH') : '-'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">สถานะการดำเนินการ</label>
                                    <p class="mt-1">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusInfo(record.trackingStatus).bgColor} ${getStatusInfo(record.trackingStatus).textColor}">
                                            ${getStatusInfo(record.trackingStatus).text}
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ปุ่มจัดการ -->
                        <div class="mt-6 flex justify-end space-x-3">
                            <button onclick="printSurveyDetails(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                🖨️ พิมพ์รายละเอียด
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium">
                                ปิด
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Print record
        function printRecord(index) {
            const record = surveyData[index];
            if (!record) {
                alert('❌ ไม่พบข้อมูลที่ต้องการพิมพ์');
                return;
            }

            // Create print window
            const printWindow = window.open('', '_blank');
            const statusInfo = getStatusInfo(record.trackingStatus);
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>รายการจัดซื้อจัดจ้าง - ${record.requesterName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
                        
                        body {
                            font-family: 'Sarabun', sans-serif;
                            margin: 20px;
                            line-height: 1.6;
                            color: #333;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #4F46E5;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        
                        .header h1 {
                            color: #4F46E5;
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                        }
                        
                        .header h2 {
                            color: #6B7280;
                            margin: 5px 0 0 0;
                            font-size: 16px;
                            font-weight: 400;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .info-item {
                            border: 1px solid #E5E7EB;
                            padding: 15px;
                            border-radius: 8px;
                            background-color: #F9FAFB;
                        }
                        
                        .info-label {
                            font-weight: 600;
                            color: #374151;
                            font-size: 14px;
                            margin-bottom: 5px;
                        }
                        
                        .info-value {
                            color: #1F2937;
                            font-size: 16px;
                        }
                        
                        .status-badge {
                            display: inline-block;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: 500;
                            background-color: #10B981;
                            color: white;
                        }
                        
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            font-size: 12px;
                            color: #6B7280;
                            border-top: 1px solid #E5E7EB;
                            padding-top: 20px;
                        }
                        
                        @media print {
                            body { margin: 0; }
                            .info-grid { grid-template-columns: 1fr; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>แบบสำรวจความต้องการจัดซื้อจัดจ้าง</h1>
                        <h2>คณะมนุษยศาสตร์และสังคมศาสตร์</h2>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">โครงการ/หน่วยงาน</div>
                            <div class="info-value">${record.projectSelection || '-'}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">ชื่อผู้ขอ</div>
                            <div class="info-value">${record.requesterName || '-'}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">ประเภทการจัดซื้อจัดจ้าง</div>
                            <div class="info-value">${record.procurementType || '-'}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">รายการพัสดุ</div>
                            <div class="info-value">${record.procurementItem || '-'}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">งบประมาณที่ใช้</div>
                            <div class="info-value">${record.totalBudget ? parseInt(record.totalBudget).toLocaleString() + ' บาท' : '-'}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">วันที่ส่งแบบสำรวจ</div>
                            <div class="info-value">${record.submissionDate || '-'}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">วันที่อัปเดตล่าสุด</div>
                            <div class="info-value">${record.lastUpdate || '-'}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">สถานะการดำเนินการ</div>
                            <div class="info-value">
                                <span class="status-badge">${statusInfo.icon} ${statusInfo.text}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <div class="info-label">รายละเอียดเพิ่มเติม</div>
                        <div class="info-value">${record.additionalDetails || '-'}</div>
                    </div>
                    
                    <div class="footer">
                        <p>พิมพ์เมื่อ: ${new Date().toLocaleDateString('th-TH', {
                            year: 'numeric',
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</p>
                        <p>ระบบแบบสำรวจความต้องการจัดซื้อจัดจ้าง คณะมนุษยศาสตร์และสังคมศาสตร์</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Print detailed survey report
        function printSurveyDetails(index) {
            const record = surveyData[index];
            if (!record) {
                alert('❌ ไม่พบข้อมูลที่ต้องการพิมพ์');
                return;
            }

            // Create print window
            const printWindow = window.open('', '_blank');
            
            // สร้างตารางรายการพัสดุ
            let itemsTable = '';
            if (record.items && record.items.length > 0) {
                itemsTable = `
                    <div class="items-section">
                        <h3>รายการที่ต้องการจัดซื้อ/จัดจ้าง</h3>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th width="8%">ลำดับ</th>
                                    <th width="20%">รายการ</th>
                                    <th width="25%">รายละเอียดวัสดุ/งานจ้าง</th>
                                    <th width="15%">วัตถุประสงค์</th>
                                    <th width="8%">จำนวน</th>
                                    <th width="8%">หน่วยนับ</th>
                                    <th width="16%">งบประมาณ/รายการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${record.items.map((item, i) => `
                                    <tr>
                                        <td class="text-center">${i + 1}</td>
                                        <td>${item.description || '-'}</td>
                                        <td>${item.note || '-'}</td>
                                        <td>${item.purpose || '-'}</td>
                                        <td class="text-center">${item.quantity || '0'}</td>
                                        <td class="text-center">${item.unit || '-'}</td>
                                        <td class="text-right">${item.total ? item.total.toLocaleString('th-TH') : '0'} บาท</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="6" class="text-right total-label">งบประมาณรวม:</td>
                                    <td class="text-right total-amount">${record.totalBudget ? parseInt(record.totalBudget).toLocaleString('th-TH') : '0'} บาท</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            }

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>รายละเอียดแบบสำรวจการจัดซื้อจัดจ้าง - ${record.fullName || 'ไม่ระบุ'}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
                        
                        body {
                            font-family: 'Sarabun', sans-serif;
                            margin: 20px;
                            line-height: 1.6;
                            color: #333;
                            font-size: 14px;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #2563EB;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        
                        .header h1 {
                            color: #2563EB;
                            margin: 0;
                            font-size: 28px;
                            font-weight: 700;
                        }
                        
                        .header h2 {
                            color: #6B7280;
                            margin: 10px 0 0 0;
                            font-size: 18px;
                            font-weight: 500;
                        }
                        
                        .section {
                            margin-bottom: 25px;
                            border: 1px solid #E5E7EB;
                            border-radius: 8px;
                            padding: 20px;
                        }
                        
                        .section-title {
                            font-size: 18px;
                            font-weight: 600;
                            margin-bottom: 15px;
                            color: #374151;
                            border-bottom: 2px solid #F3F4F6;
                            padding-bottom: 8px;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                        }
                        
                        .info-item {
                            display: flex;
                            flex-direction: column;
                        }
                        
                        .info-label {
                            font-weight: 600;
                            color: #6B7280;
                            font-size: 13px;
                            margin-bottom: 5px;
                        }
                        
                        .info-value {
                            font-weight: 500;
                            color: #1F2937;
                        }
                        
                        .items-section {
                            margin-top: 20px;
                        }
                        
                        .items-section h3 {
                            font-size: 18px;
                            font-weight: 600;
                            margin-bottom: 15px;
                            color: #374151;
                        }
                        
                        .items-table {
                            width: 100%;
                            border-collapse: collapse;
                            border: 1px solid #D1D5DB;
                        }
                        
                        .items-table th,
                        .items-table td {
                            border: 1px solid #D1D5DB;
                            padding: 8px;
                            text-align: left;
                        }
                        
                        .items-table th {
                            background-color: #F9FAFB;
                            font-weight: 600;
                            font-size: 13px;
                        }
                        
                        .items-table td {
                            font-size: 12px;
                        }
                        
                        .text-center {
                            text-align: center;
                        }
                        
                        .text-right {
                            text-align: right;
                        }
                        
                        .total-label {
                            background-color: #F9FAFB;
                            font-weight: 600;
                        }
                        
                        .total-amount {
                            background-color: #F0FDF4;
                            font-weight: 700;
                            color: #16A34A;
                            font-size: 14px;
                        }
                        
                        .status-badge {
                            display: inline-block;
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 600;
                        }
                        
                        .user-section { background-color: #EFF6FF; }
                        .project-section { background-color: #F0FDF4; }
                        .additional-section { background-color: #FFFBEB; }
                        
                        @media print {
                            body { margin: 10px; }
                            .section { break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>📋 รายละเอียดแบบสำรวจการจัดซื้อจัดจ้าง</h1>
                        <h2>คณะมนุษยศาสตร์และสังคมศาสตร์</h2>
                        <p style="margin: 10px 0 0 0; color: #6B7280;">วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH')} เวลา: ${new Date().toLocaleTimeString('th-TH')}</p>
                    </div>
                    
                    <div class="section user-section">
                        <div class="section-title">👤 ข้อมูลผู้ตอบแบบสำรวจ</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">ชื่อ-นามสกุล</div>
                                <div class="info-value">${record.fullName || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">หน่วยงาน/ฝ่าย</div>
                                <div class="info-value">${record.department || '-'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section project-section">
                        <div class="section-title">🎯 ข้อมูลโครงการและการจัดหา</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">โครงการ</div>
                                <div class="info-value">${record.projectSelection || '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ประเภทการจัดหา</div>
                                <div class="info-value">${record.procurementType || '-'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="info-item">
                                <div class="info-label">พัสดุที่จัดหา</div>
                                <div class="info-value">${record.procurementItem || '-'}</div>
                            </div>
                        </div>
                        ${itemsTable}
                    </div>
                    
                    <div class="section additional-section">
                        <div class="section-title">📄 ข้อมูลเพิ่มเติม</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">วันที่ส่งแบบสำรวจ</div>
                                <div class="info-value">${record.submitDate ? new Date(record.submitDate).toLocaleDateString('th-TH') : '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">วันที่อัปเดตล่าสุด</div>
                                <div class="info-value">${record.lastUpdated ? new Date(record.lastUpdated).toLocaleDateString('th-TH') : '-'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">สถานะการดำเนินการ</div>
                                <div class="info-value">
                                    <span class="status-badge" style="background-color: ${getStatusInfo(record.trackingStatus).color}20; color: ${getStatusInfo(record.trackingStatus).color};">
                                        ${getStatusInfo(record.trackingStatus).text}
                                    </span>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">งบประมาณรวมทั้งสิ้น</div>
                                <div class="info-value" style="font-size: 16px; font-weight: 700; color: #16A34A;">
                                    ${record.totalBudget ? parseInt(record.totalBudget).toLocaleString('th-TH') : '0'} บาท
                                </div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 1000);
        }

        // Initialize tracking when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTrackingData();
        });
    </script>

    <!-- Modern Footer -->
    <footer class="bg-gradient-to-r from-gray-800 to-gray-900 text-white py-8 mt-12">
        <div class="container mx-auto px-6">
            <div class="grid md:grid-cols-3 gap-8">
                <!-- System Info -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 text-blue-300">📋 ระบบสำรวจความต้องการพัสดุ</h3>
                    <p class="text-gray-300 text-sm leading-relaxed">
                        ระบบจัดการแบบสำรวจความต้องการพัสดุสำหรับการจัดซื้อจัดจ้าง
                        ประจำปีงบประมาณ พ.ศ. 2569
                    </p>                    
                </div>
                
                <!-- Organization Info -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 text-blue-300">🏛️ หน่วยงาน</h3>
                    <p class="text-gray-300 text-sm leading-relaxed">
                        คณะมนุษยศาสตร์และสังคมศาสตร์<br>
                        มหาวิทยาลัยราชภัฏสุราษฎร์ธานี<br>
                        จังหวัดสุราษฎร์ธานี <br>
                        โทร 077-913363
                    </p>

                </div>
                
                <!-- Development Team -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 text-blue-300">👨‍💻 ทีมพัฒนาระบบ</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center text-gray-300">
                            <span class="inline-block w-2 h-2 bg-purple-400 rounded-full mr-3"></span>
                            <span>นางสาวอธิฐาน ศรีสวัสดิ์</span>
                        </div>
                        <div class="flex items-center text-gray-300">
                            <span class="inline-block w-2 h-2 bg-blue-400 rounded-full mr-3"></span>
                            <span>นายอพิสิทธิ ชมเชย</span>
                        </div>
                        <div class="flex items-center text-gray-300">
                            <span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-3"></span>
                            <span>นายศุภวัชช์ ศรีพัฒน์</span>
                        </div>
                    </div>
                    
                    <!-- Tech Stack -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <span class="px-2 py-1 bg-gray-700 text-xs rounded-full text-gray-300">HTML5</span>
                        <span class="px-2 py-1 bg-gray-700 text-xs rounded-full text-gray-300">JavaScript</span>
                        <span class="px-2 py-1 bg-gray-700 text-xs rounded-full text-gray-300">Tailwind CSS</span>
                        <span class="px-2 py-1 bg-gray-700 text-xs rounded-full text-gray-300">Chart.js</span>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Footer -->
            <div class="border-t border-gray-700 mt-8 pt-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="text-sm text-gray-400 mb-4 md:mb-0">
                        © 2569 (2025) ระบบสำรวจความต้องการพัสดุ - สงวนลิขสิทธิ์
                    </div>
                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                        <span class="flex items-center">
                            <span class="mr-2">🚀</span>
                            เวอร์ชัน 1.0
                        </span>
                        <span class="flex items-center">
                            <span class="mr-2">⏰</span>
                            <script>document.write('อัพเดท: ' + new Date().toLocaleDateString('th-TH'));</script>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        
        // Check button state when page loads
        window.addEventListener('load', function() {
            // Page loaded, initialize tracking data
            loadTrackingData();
        });
    </script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9878565692c0893d',t:'MTc1OTI4MzcyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>



